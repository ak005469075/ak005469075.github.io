<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>scrapy爬虫 |  小张之栈</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      <canvas class="fireworks"></canvas>
      <style>
        .fireworks {
          position: fixed;
          left: 0;
          top: 0;
          z-index: 99999;
          pointer-events: none;
        }
      </style>
      
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-python爬虫"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
  
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  scrapy爬虫
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/09/22/python%E7%88%AC%E8%99%AB/" class="article-date">
  <time datetime="2023-09-21T23:12:30.000Z" itemprop="datePublished">2023-09-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%88%AC%E8%99%AB/">爬虫</a> / <a class="article-category-link" href="/categories/%E7%88%AC%E8%99%AB/scrapy/">scrapy</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">6.9k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">33 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="一、基础知识"><a href="#一、基础知识" class="headerlink" title="一、基础知识"></a>一、基础知识</h1><h2 id="1-技术选型"><a href="#1-技术选型" class="headerlink" title="1.技术选型"></a>1.技术选型</h2><ul>
<li>scrapy为框架，requests与beautifulsoup为库</li>
<li>scrapy内置有css和xpath selector，较为方便，beautifulsoup缺点是慢</li>
</ul>
<h2 id="2-网页分类"><a href="#2-网页分类" class="headerlink" title="2.网页分类"></a>2.网页分类</h2><p>1.静态网页</p>
<p>2.动态网页</p>
<p>3.webserver，(ajax方式与后台api交互，也属于动态网页技术)</p>
<h2 id="3-正则表达式"><a href="#3-正则表达式" class="headerlink" title="3.正则表达式"></a>3.正则表达式</h2><h3 id="1-开始字符-a"><a href="#1-开始字符-a" class="headerlink" title="1.开始字符^a"></a>1.开始字符^a</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">line=<span class="string">&quot;boddy123&quot;</span></span><br><span class="line">regex_str=<span class="string">&quot;^b.*&quot;</span> <span class="comment"># ^b是以后面的字符b为开头，.表示任意一个字符，*表示匹配0到多个字符</span></span><br><span class="line"><span class="keyword">if</span> re.<span class="keyword">match</span>(regex_str,line):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;yes&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>yes</p>
</blockquote>
<h3 id="2-结尾字符a"><a href="#2-结尾字符a" class="headerlink" title="2.结尾字符a$"></a>2.结尾字符a$</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regex_str=<span class="string">&quot;^.*3$&quot;</span> <span class="comment"># 3$以3结尾</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>yes</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regex_str=<span class="string">&quot;^b.3$&quot;</span> <span class="comment"># 3$以3结尾，这总共是3个字符</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>空</p>
</blockquote>
<h3 id="3-与"><a href="#3-与" class="headerlink" title="3.?与()"></a>3.?与()</h3><p><code>()</code>分组，捕获组，如果目标字符串有()，直接转义即可</p>
<p>假设有一字符串如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">line=<span class="string">&quot;boooooooooobbbby123&quot;</span></span><br></pre></td></tr></table></figure>

<p>提取目标为 <code>boooooooooob</code>，构造正则如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">...</span><br><span class="line">regex_str=<span class="string">&quot;.*(b.*b).*&quot;</span></span><br><span class="line">match_obj=re.<span class="keyword">match</span>(regex_str,line)</span><br><span class="line"><span class="keyword">if</span> match_obj:</span><br><span class="line">    <span class="built_in">print</span>(match_obj.group(<span class="number">1</span>)) <span class="comment">#group(1)，第1个括号匹配部分</span></span><br></pre></td></tr></table></figure>

<p>输出为</p>
<blockquote>
<p>bb</p>
</blockquote>
<p>分析，上述这种正则为<strong>贪婪匹配</strong>，从左到右匹配，找出满足正则的情况，bb是最终满足的情况(前面也有满足的情况，但被后面满足的情况覆盖了)，熟悉贪心算法的不陌生吧</p>
<p><code>?</code>控制匹配方式，非贪婪匹配</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regex_str=<span class="string">&quot;.*?(b.*?b).*&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>boooooooooob</p>
</blockquote>
<p>当 <code>?</code>附加在其它匹配字符( <code>*?</code>、<code>+?</code>、<code>??</code>等)后面，表示尽可能少地匹配前面的元字符，即非重叠的匹配</p>
<p>否则</p>
<p><code>regex_str=&quot;.*(b.*?b).*&quot;</code></p>
<blockquote>
<p>bb</p>
</blockquote>
<p><code>regex_str=&quot;.*?(b.*b).*&quot;</code></p>
<blockquote>
<p>boooooooooobbbb</p>
</blockquote>
<h3 id="4-至少匹配1次"><a href="#4-至少匹配1次" class="headerlink" title="4.+ 至少匹配1次"></a>4.+ 至少匹配1次</h3><p><code>+</code>，匹配至少出现一次</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">line=<span class="string">&quot;boooooobaaoooobbbby123&quot;</span></span><br><span class="line">regex_str=<span class="string">&quot;.*(b.*b).*&quot;</span></span><br></pre></td></tr></table></figure>

<p>这样的结果，已知为bb，因为 <code>.*</code>中， <code>.</code>单独的作用是匹配一次任意非换行字符，但是 <code>.*</code>表示 <code>*</code>匹配前面的字符 <code>.</code>0次或多次</p>
<p>而如果是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">line=<span class="string">&quot;boooooobaaoooobbbby123&quot;</span></span><br><span class="line">regex_str=<span class="string">&quot;.*(b.+b).*&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>bbb </p>
</blockquote>
<p><code>.+</code>最少也要匹配 <code>.</code>一次</p>
<h3 id="5-a-，-a-b-，限定匹配"><a href="#5-a-，-a-b-，限定匹配" class="headerlink" title="5.{a}，{a,b}，限定匹配"></a>5.{a}，{a,b}，限定匹配</h3><p> {a}，限定匹配a个字符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">line=<span class="string">&quot;boooooobaaoooobbbaaby123&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;.*(b.&#123;2&#125;b).*&quot;</span></span><br><span class="line"><span class="comment"># baab</span></span><br><span class="line">regex_str=<span class="string">&quot;.*(b.&#123;3&#125;b).*&quot;</span></span><br><span class="line"><span class="comment">#bbaab</span></span><br><span class="line">line=<span class="string">&quot;boooooobaaoooobbbaaby123&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;.*(b.&#123;7,10&#125;b).*&quot;</span></span><br><span class="line"><span class="comment">#将.匹配至少7次，最多10次</span></span><br><span class="line"><span class="comment">#baaoooobbb，这是贪婪匹配，仅保留最终结果</span></span><br></pre></td></tr></table></figure>

<h3 id="6-或"><a href="#6-或" class="headerlink" title="6.|或"></a>6.|或</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">line=<span class="string">&quot;bobby123&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;((bobby|boaabby)123)&quot;</span></span><br><span class="line">match_obj=re.<span class="keyword">match</span>(regex_str,line)</span><br><span class="line"><span class="keyword">if</span> match_obj:</span><br><span class="line">    <span class="built_in">print</span>(match_obj.group(<span class="number">1</span>))</span><br><span class="line"><span class="comment">#bobby123</span></span><br><span class="line"><span class="built_in">print</span>(match_obj.group(<span class="number">2</span>))</span><br><span class="line"><span class="comment">#bobby</span></span><br></pre></td></tr></table></figure>

<h3 id="7-任取-x2F-区间-x2F-取反"><a href="#7-任取-x2F-区间-x2F-取反" class="headerlink" title="7.[]任取&#x2F;区间&#x2F;取反"></a>7.[]任取&#x2F;区间&#x2F;取反</h3><ul>
<li><code>[abcd]</code>括号内取其中<strong>一个满足</strong>的</li>
<li><code>[a=b]</code>取区间内的值</li>
<li><code>[^1]</code>不等于1</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">line=<span class="string">&quot;13992574364&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;(1[12379][0-9]&#123;9&#125;)&quot;</span> </span><br><span class="line">match_obj=re.<span class="keyword">match</span>(regex_str,line)</span><br><span class="line"><span class="keyword">if</span> match_obj:</span><br><span class="line">    <span class="built_in">print</span>(match_obj.group(<span class="number">1</span>))</span><br><span class="line"><span class="comment">#13992574364</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;16992574364&quot;</span></span><br><span class="line"><span class="comment">#无结果</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;13sssssssss&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;(1[12379][^1]&#123;9&#125;)&quot;</span> <span class="comment">#取反，9个字符不为1即可 </span></span><br><span class="line"><span class="comment">#13sssssssss</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;yuslei&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;(yu[A-Za-z0-9_]lei)&quot;</span> <span class="comment">#中括号任意一个匹配</span></span><br><span class="line"><span class="comment">#yuslei</span></span><br></pre></td></tr></table></figure>

<h3 id="8-s-S-w-W-d"><a href="#8-s-S-w-W-d" class="headerlink" title="8.\s,\S,\w,\W,\d"></a>8.\s,\S,\w,\W,\d</h3><p><code>\s</code>一个空格</p>
<p><code>\S</code>一个非空格</p>
<p><code>\w``=[A-Za-z0-9_]</code> </p>
<p><code>\W</code>取反</p>
<p><code>\d</code>数字</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">line=<span class="string">&quot;yu lei&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;(yu\slei)&quot;</span></span><br><span class="line"><span class="comment">#yu lei</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;yu  lei&quot;</span> <span class="comment">#两个空格</span></span><br><span class="line"><span class="comment">#无结果</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;yuxiaolei&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;(yu\slei)&quot;</span></span><br><span class="line"><span class="comment">#无结果</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;yuslei&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;(yu\Slei)&quot;</span></span><br><span class="line"><span class="comment">#yuslei</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;yusslei&quot;</span> </span><br><span class="line"><span class="comment">#无结果</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;we are born in 2021年&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;.*?(\d+)年&quot;</span></span><br><span class="line"><span class="comment">#2021</span></span><br></pre></td></tr></table></figure>



<h3 id="9-u4E00-u9FA5-汉字"><a href="#9-u4E00-u9FA5-汉字" class="headerlink" title="9.[\u4E00-\u9FA5] 汉字"></a>9.[\u4E00-\u9FA5] 汉字</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">line=<span class="string">&quot;你好we&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;([\u4E00-\u9FA5]+)&quot;</span></span><br><span class="line"><span class="comment">#你好</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;你 好we&quot;</span> </span><br><span class="line"><span class="comment">#你</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;we are 家人侠&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;.*([\u4E00-\u9FA5]+侠)&quot;</span><span class="comment">#因为+至少取1个，已经满足了</span></span><br><span class="line"><span class="comment">#人侠</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;we are 家人侠&quot;</span> </span><br><span class="line">regex_str=<span class="string">&quot;.*?([\u4E00-\u9FA5]+侠)&quot;</span></span><br><span class="line"><span class="comment">#家人侠</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="实例-出生日期提取"><a href="#实例-出生日期提取" class="headerlink" title="实例-出生日期提取"></a>实例-出生日期提取</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">line=<span class="string">&quot;XXX生于2023年9月2日&quot;</span></span><br><span class="line"><span class="comment"># line=&quot;XXX生于2023/9/2&quot;</span></span><br><span class="line"><span class="comment"># line=&quot;XXX生于2023-9-2&quot;</span></span><br><span class="line"><span class="comment"># line=&quot;XXX生于2023-09-02&quot;</span></span><br><span class="line">regex_str=<span class="string">&quot;.*?(\d+).?(\d+).?(\d+)&quot;</span></span><br><span class="line">match_obj=re.<span class="keyword">match</span>(regex_str,line)</span><br><span class="line"><span class="keyword">if</span> match_obj:</span><br><span class="line">    <span class="built_in">print</span>(match_obj.group(<span class="number">1</span>)+match_obj.group(<span class="number">2</span>)+match_obj.group(<span class="number">3</span>))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">line=<span class="string">&quot;XXX生于2023年9月2日&quot;</span></span><br><span class="line">line=<span class="string">&quot;XXX生于2023/9/2&quot;</span></span><br><span class="line">line=<span class="string">&quot;XXX生于2023-9-2&quot;</span></span><br><span class="line">line=<span class="string">&quot;XXX生于2023-09-02&quot;</span></span><br><span class="line"><span class="comment">#line=&quot;XXX生于2023-09&quot;</span></span><br><span class="line">regex_str=<span class="string">&quot;.*生于(\d&#123;4&#125;[年/-]\d&#123;1,2&#125;[月/-](\d&#123;1,2&#125;|$))&quot;</span></span><br><span class="line">match_obj=re.<span class="keyword">match</span>(regex_str,line)</span><br><span class="line"><span class="keyword">if</span> match_obj:</span><br><span class="line">    <span class="built_in">print</span>(match_obj.group(<span class="number">1</span>))</span><br><span class="line"><span class="comment">#2023年9月2</span></span><br><span class="line"><span class="comment">#2023/9/2</span></span><br><span class="line"><span class="comment">#2023-9-2</span></span><br><span class="line"><span class="comment">#2023-09-02</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;XXX生于2023-09&quot;</span></span><br><span class="line">regex_str=<span class="string">&quot;.*生于(\d&#123;4&#125;[年/-]\d&#123;1,2&#125;[月/-](\d&#123;1,2&#125;|$))&quot;</span></span><br><span class="line"><span class="comment">#无结果</span></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;XXX生于2023-09&quot;</span></span><br><span class="line">regex_str=<span class="string">&quot;.*生于(\d&#123;4&#125;[年/-]\d&#123;1,2&#125;([月/-]|\d&#123;1,2&#125;|$))&quot;</span></span><br><span class="line"><span class="comment">#2023-09 但是满足不了前面的了</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">line=<span class="string">&quot;XXX生于2023年9月2日&quot;</span></span><br><span class="line">line=<span class="string">&quot;XXX生于2023/9/2&quot;</span></span><br><span class="line">line=<span class="string">&quot;XXX生于2023-9-2&quot;</span></span><br><span class="line">line=<span class="string">&quot;XXX生于2023-09-02&quot;</span></span><br><span class="line">line=<span class="string">&quot;XXX生于2023-09&quot;</span></span><br><span class="line">regex_str=<span class="string">&quot;.*生于(\d&#123;4&#125;[年/-]\d&#123;1,2&#125;([月/-]\d&#123;1,2&#125;|[月/-]$|$))&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#都可以了</span></span><br><span class="line"><span class="comment">#为什么[月-/]会报错嘞</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-深度优先-x2F-广度优先"><a href="#4-深度优先-x2F-广度优先" class="headerlink" title="4.深度优先&#x2F;广度优先"></a>4.深度优先&#x2F;广度优先</h2><h3 id="网站url的树结构"><a href="#网站url的树结构" class="headerlink" title="网站url的树结构"></a>网站url的树结构</h3><p><img src="https://raw.githubusercontent.com/ak005469075/myblog/main/img/image-20230922105721612.png"></p>
<h3 id="深度优先-x2F-广度优先"><a href="#深度优先-x2F-广度优先" class="headerlink" title="深度优先&#x2F;广度优先"></a>深度优先&#x2F;广度优先</h3><p>学过数据结构都知道了，不赘述</p>
<h2 id="5-爬虫去重"><a href="#5-爬虫去重" class="headerlink" title="5.爬虫去重"></a>5.爬虫去重</h2><p>1.访问过的url存进数据库</p>
<p>2.url-&gt;hashset，但占用内存大，性能低</p>
<p>3.md5(url)-&gt;hashset，这是scrapy的方法</p>
<h2 id="6-字符串编码"><a href="#6-字符串编码" class="headerlink" title="6.字符串编码"></a>6.字符串编码</h2><p>ASCII(一个字节)编码</p>
<p>但中文很多汉字，所以有GB2312编码</p>
<p>于是Unicode出现了，统一编码</p>
<p>但是如果内容全是英文，Unicode编码比ASCII多一倍存储空间</p>
<p>所以有utf-8编码</p>
<p>所以内存为unicode编码，文件为utf-8编码</p>
<h1 id="二、实例"><a href="#二、实例" class="headerlink" title="二、实例"></a>二、实例</h1><p>我用的vscode，新建一个文件夹，在终端下输入 <code>pip install scrapy</code></p>
<h2 id="1-新建项目"><a href="#1-新建项目" class="headerlink" title="1.新建项目"></a>1.新建项目</h2><p>终端输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#scrapy startproject &lt;project_name&gt; [project_dir]</span></span><br><span class="line">scrapy startproject name kaipa </span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> kaipa</span><br><span class="line">scrapy genspider example example.com <span class="comment">#生成eample.py的开始地址为example.com的基础模板</span></span><br><span class="line">scrapy crawl 项目名</span><br></pre></td></tr></table></figure>

<p>此处，我的项目名为 <code>name</code></p>
<p><img src="https://raw.githubusercontent.com/ak005469075/myblog/main/img/image-20230922115033027.png"></p>
<h2 id="2-调试"><a href="#2-调试" class="headerlink" title="2.调试"></a>2.调试</h2><p>我用的vscode，参考<a target="_blank" rel="noopener" href="http://t.csdn.cn/PKqWc">http://t.csdn.cn/PKqWc</a></p>
<blockquote>
<p>Scrapy 2.11.0 - no active project</p>
<p>Unknown command: crawl</p>
<p>Use “scrapy” to see available commands</p>
<p>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45476428/article/details/108707622">https://blog.csdn.net/qq_45476428/article/details/108707622</a></p>
</blockquote>
<p>settings中使得</p>
<blockquote>
<p>ROBOTSTXT_OBEY &#x3D; False #否则爬虫会过滤一些url</p>
</blockquote>
<h2 id="3-各模块作用"><a href="#3-各模块作用" class="headerlink" title="3.各模块作用"></a>3.各模块作用</h2><h3 id="items-py"><a href="#items-py" class="headerlink" title="items.py"></a>items.py</h3><p>将需要爬取的信息封装成一个类,方便后期数据的保存</p>
<h3 id="pipelines-py"><a href="#pipelines-py" class="headerlink" title="pipelines.py"></a>pipelines.py</h3><p>随着项目的创建而自动创建,该模块主要是完成数据保存到外部文件中。</p>
<p>在完整的代码中,一共有三个pipelines模块:</p>
<p>pipelines.py将数据保存到txt文件中,</p>
<p>pipelines_excel.py将数据保存到excel表中,</p>
<p>pipelines_mysql.py将数据保存到mysql数据库中</p>
<p>分成多个pipelines时,需要修改setting.py中的代码,在65行附件有一段注释掉的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ITEM_PIPELINES = &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#qkhouse.pipelines.QkhousePipeline&#x27;: 300,</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>

<p>若你只有一个pipelines,直接取消注释即可,代码中的300表示优先级,因为只有一个pipelines,所以优先级设置的大小没有影响.</p>
<p>若有多个pipelines时,你就需要设置pipelines优先级的大小:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">&#x27;qkhouse.pipelines.QkhousePipeline&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">   <span class="string">&#x27;qkhouse.pipelines_excel.QkhousePipeline&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">   <span class="string">&#x27;qkhouse.pipelines_mysql.QkhousePipeline&#x27;</span>: <span class="number">3</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Xpath作用"><a href="#4-Xpath作用" class="headerlink" title="4.Xpath作用"></a>4.Xpath作用</h2><p>先点进目标网页其中一个页面</p>
<p><img src="https://raw.githubusercontent.com/ak005469075/myblog/main/img/image-20230922132751862.png"></p>
<p>尝试提取标题，日期，评论个数</p>
<h3 id="1-概要"><a href="#1-概要" class="headerlink" title="1.概要"></a>1.概要</h3><ul>
<li>路径表达式在xml和html中导航</li>
<li>包含标准函数库</li>
<li>w3c标准</li>
</ul>
<h4 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> //父节点 Parent  //html是meta的先辈节点 Ancestor</span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span> //是html的子节点 Child</span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span>/&gt;</span> //meta与link是同胞节点 Sibling</span><br><span class="line">       </span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-语法"><a href="#2-语法" class="headerlink" title="2.语法"></a>2.语法</h3><table>
<thead>
<tr>
<th>表达式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>article</td>
<td>选取所有article元素的所有<strong>子节点</strong></td>
</tr>
<tr>
<td>&#x2F;article</td>
<td>选取<strong>根元素</strong>article</td>
</tr>
<tr>
<td>article&#x2F;a</td>
<td>选取所有<strong>属于article元素的a元素</strong></td>
</tr>
<tr>
<td>&#x2F;&#x2F;div</td>
<td>选取所有div子元素</td>
</tr>
<tr>
<td>article&#x2F;&#x2F;div</td>
<td>选取所有属于article元素的后代div元素</td>
</tr>
<tr>
<td>&#x2F;&#x2F;@class</td>
<td>选取所有名为class的<strong>属性</strong> &lt;img src&#x3D;”…”&gt;  src就是属性</td>
</tr>
</tbody></table>
<blockquote>
<p>参考链接</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wendyw/p/11633588.html#_label3">https://www.cnblogs.com/wendyw/p/11633588.html#_label3</a></p>
<p>菜鸟教程<a target="_blank" rel="noopener" href="https://www.runoob.com/xpath/xpath-syntax.html">https://www.runoob.com/xpath/xpath-syntax.html</a></p>
</blockquote>
<h4 id="找标题"><a href="#找标题" class="headerlink" title="找标题"></a>找标题</h4><p><strong>首先已经指定某一个静态网页url了</strong></p>
<h5 id="写法1"><a href="#写法1" class="headerlink" title="写法1"></a>写法1</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/html/body/main/div[2]/div[2]/div/h1</span><br></pre></td></tr></table></figure>

<p>按路径找的，&#x2F;可以理解为是嵌套关系</p>
<p>&#x2F;html&#x2F;body，在html标签下有个body</p>
<p>依次类推</p>
<p>main&#x2F;div[2]，表示main标签下的第二个div</p>
<p>实际上，f12，浏览器是提供复制Xpath功能的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re_selector=response.xpath(<span class="string">&quot;/html/body/main/div[2]/div[2]/div/h1&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>debug一下</p>
<p>鼠标移到上面，应该有东西，哈，有点问题</p>
<p>加个 <code>/text()</code>才有东西，具体原因，请往下看，技巧部分</p>
<h5 id="写法2"><a href="#写法2" class="headerlink" title="写法2"></a>写法2</h5><p>更简短吧，当然了，要确保class的值是<strong>全局唯一</strong>的</p>
<p>如 <code>//a[@href=&quot;...&quot;]</code></p>
<p>如果class名字过长怎么办，有函数contains，如</p>
<p><code>//span[contains(@class,&quot;vo-up1&quot;)]</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//div[@class=&quot;article-header mb-0&quot;]/h1/text()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re_selector=response.xpath(<span class="string">&#x27;//div[@class=&quot;article-header mb-0&quot;]/h1/text()&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>再debug一下</p>
<p><img src="https://raw.githubusercontent.com/ak005469075/myblog/main/img/image-20230922142255015.png"></p>
<h5 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h5><p>这里有个技巧，你看，上面两种写法，调试的时候，每次都要重新启动debug，别慌，在cmd下，cd到有scrapy脚本的地方，</p>
<p>输入 <code>scrapy shell 爬取网址</code>  </p>
<p><strong>But！！！</strong></p>
<p>我的朋友，如果你和我一样，用的也是vscode，<del>那可真是，太酷啦！！！</del> 或者其它平台，就在<strong>下方的终端</strong>去启动就行了</p>
<p>比如我的cd kaipa(我的项目名)，去启动scrapy shell</p>
<p>然后 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scrapy shell 爬取网址</span><br><span class="line">&gt;&gt;&gt; title=responses.xpath(<span class="string">&quot;...&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; title  <span class="comment">#打印一下</span></span><br><span class="line">&gt;&gt;&gt; title.extract() <span class="comment">#提取数值元组</span></span><br><span class="line">&gt;&gt;&gt; title.extract()[0] <span class="comment">#提取第一个数值</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [1]: title=response.xpath(<span class="string">&quot;/html/body/main/div[2]/div[2]/div/h1&quot;</span>)</span><br><span class="line"></span><br><span class="line">In [2]: title</span><br><span class="line">Out[2]: [&lt;Selector query=<span class="string">&#x27;/html/body/main/div[2]/div[2]/div/h1&#x27;</span> data=<span class="string">&#x27;&lt;h1 class=&quot;post-title mb-2 mb-lg-3&quot;&gt;A...&#x27;</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [3]: title.extract()</span><br><span class="line">Out[3]: [<span class="string">&#x27;&lt;h1 class=&quot;post-title mb-2 mb-lg-3&quot;&gt;Apple 苹果产品参数中心 收集苹果全部产品的详细参数&lt;/h1&gt;&#x27;</span>]</span><br><span class="line"></span><br><span class="line">In [4]: title.extract()[0]</span><br><span class="line">Out[4]: <span class="string">&#x27;&lt;h1 class=&quot;post-title mb-2 mb-lg-3&quot;&gt;Apple 苹果产品参数中心 收集苹果全部产品的详细参数&lt;/h1&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">In [5]: title=response.xpath(<span class="string">&quot;//div[@class=&#x27;article-header mb-0&#x27;]/h1/text()&quot;</span>)       </span><br><span class="line"></span><br><span class="line">In [6]: title</span><br><span class="line">Out[6]: [&lt;Selector query=<span class="string">&quot;//div[@class=&#x27;article-header mb-0&#x27;]/h1/text()&quot;</span> data=<span class="string">&#x27;Apple 苹果产品参数中心 收集苹果全部产品的详细参数&#x27;</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [7]: title.extract()[0]</span><br><span class="line">Out[7]: <span class="string">&#x27;Apple 苹果产品参数中心 收集苹果全部产品的详细参数&#x27;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [8]: title=response.xpath(<span class="string">&quot;/html/body/main/div[2]/div[2]/div/h1/text()&quot;</span>)</span><br><span class="line"></span><br><span class="line">In [9]: title</span><br><span class="line">Out[9]: [&lt;Selector query=<span class="string">&#x27;/html/body/main/div[2]/div[2]/div/h1/text()&#x27;</span> data=<span class="string">&#x27;Apple 苹果产品参数中心 收集苹果全部产品的详细参数&#x27;</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [10]: title.extract()[0]</span><br><span class="line">Out[10]: <span class="string">&#x27;Apple 苹果产品参数中心 收集苹果全部产品的详细参数&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="爬日期"><a href="#爬日期" class="headerlink" title="爬日期"></a>爬日期</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//div[@class=&quot;article-meta&quot;]/span[1]/text()</span><br></pre></td></tr></table></figure>

<p>去终端试一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [11]: title1=response.xpath(<span class="string">&quot;//div[@class=&#x27;article-meta&#x27;]/span[1]/text()&quot;</span>)       </span><br><span class="line"></span><br><span class="line">In [12]: title1</span><br><span class="line">Out[12]: [&lt;Selector query=<span class="string">&quot;//div[@class=&#x27;article-meta&#x27;]/span[1]/text()&quot;</span> data=<span class="string">&#x27;2023-09-14&#x27;</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [13]: title1.extract()</span><br><span class="line">Out[13]: [<span class="string">&#x27;2023-09-14&#x27;</span>]</span><br><span class="line"></span><br><span class="line">In [14]: title1.extract()[0]</span><br><span class="line">Out[14]: <span class="string">&#x27;2023-09-14&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="爬评论"><a href="#爬评论" class="headerlink" title="爬评论"></a>爬评论</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//span[@class=&quot;meta-comment&quot;]/a/text()</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [20]: response.xpath(<span class="string">&quot;//span[@class=&#x27;meta-comment&#x27;]/a/text()&quot;</span>)</span><br><span class="line">Out[20]: [&lt;Selector query=<span class="string">&quot;//span[@class=&#x27;meta-comment&#x27;]/a/text()&quot;</span> data=<span class="string">&#x27;1&#x27;</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [21]: response.xpath(<span class="string">&quot;//span[@class=&#x27;meta-comment&#x27;]/a/text()&quot;</span>).extract()</span><br><span class="line">Out[21]: [<span class="string">&#x27;1&#x27;</span>]</span><br><span class="line"></span><br><span class="line">In [22]: response.xpath(<span class="string">&quot;//span[@class=&#x27;meta-comment&#x27;]/a/text()&quot;</span>).extract()[0]      </span><br><span class="line">Out[22]: <span class="string">&#x27;1&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="爬收藏"><a href="#爬收藏" class="headerlink" title="爬收藏"></a>爬收藏</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//div[@class=&quot;article-meta&quot;]/span[contains(@class,&quot;meta-fav&quot;)]/text()</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [23]: response.xpath(<span class="string">&#x27;//div[@class=&quot;article-meta&quot;]/span[contains(@class,&quot;meta-fav&quot;)]/text()&#x27;</span>).extract()</span><br><span class="line">Out[23]: [<span class="string">&#x27;3&#x27;</span>]</span><br><span class="line"></span><br><span class="line">In [24]: response.xpath(<span class="string">&#x27;//div[@class=&quot;article-meta&quot;]/span[contains(@class,&quot;meta-fav&quot;)]/text()&#x27;</span>).extract()[0]</span><br><span class="line">Out[24]: <span class="string">&#x27;3&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="爬内容"><a href="#爬内容" class="headerlink" title="爬内容"></a>爬内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [35]: response.xpath(<span class="string">&#x27;//div[@class=&quot;card&quot;]/article&#x27;</span>).extract()</span><br><span class="line">Out[35]: ... <span class="comment">#太多了，不展示了</span></span><br></pre></td></tr></table></figure>

<h4 id="综上"><a href="#综上" class="headerlink" title="综上"></a>综上</h4><p>对于likes和comment部分，其实根据实际情况判断，</p>
<p>如果某网页显示的是， <code>3 评论</code> ，没有评论时，只显示 <code>评论</code></p>
<p>需要逻辑判断一下</p>
<p>比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">match_re=re.<span class="keyword">match</span>(<span class="string">&quot;.*?(\d+).*&quot;</span>,comment)</span><br><span class="line"><span class="keyword">if</span> match_re:</span><br><span class="line">    comment=match_re.group(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    comment=<span class="number">0</span></span><br></pre></td></tr></table></figure>



<h4 id="其他例子"><a href="#其他例子" class="headerlink" title="其他例子"></a>其他例子</h4><p>有个例子就是</p>
<p>如果一个div标签下有多个同级span，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tag=response.xpath(<span class="string">&#x27;//div[@class=&quot;articlemeta&quot;]/span/text()&#x27;</span>).extract() </span><br><span class="line">Out[44]: [<span class="string">&#x27;2023-09-14&#x27;</span>, <span class="string">&#x27;0 评论&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#假设除了tag[1]的内容，我都要，且拼接成字符串</span></span><br><span class="line"><span class="comment">#我当然可以tag[0]，tag[2]，tag[3]那样去取</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#这里有另一种方法</span></span><br><span class="line">tag_list=response.xpath(<span class="string">&#x27;//div[@class=&quot;articlemeta&quot;]/span/text()&#x27;</span>).extract()</span><br><span class="line"></span><br><span class="line">tag_list=[elem <span class="keyword">for</span> elem <span class="keyword">in</span> tag <span class="keyword">if</span> <span class="keyword">not</span> elem.strip().endwith(<span class="string">&quot;评论&quot;</span>)]</span><br><span class="line">tags=<span class="string">&quot;,&quot;</span>.join(tag_list)</span><br></pre></td></tr></table></figure>

<h2 id="5-css选择器实现字段解析"><a href="#5-css选择器实现字段解析" class="headerlink" title="5.css选择器实现字段解析"></a>5.css选择器实现字段解析</h2><p><a target="_blank" rel="noopener" href="https://www.runoob.com/cssref/css-selectors.html">https://www.runoob.com/cssref/css-selectors.html</a></p>
<h3 id="爬取实例"><a href="#爬取实例" class="headerlink" title="爬取实例"></a>爬取实例</h3><p><strong>标题</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container py-3 py-md-5&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;article-header mb-0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;post-title mb-2 mb-lg-3&quot;</span>&gt;</span>Apple 苹果...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.article-header h1</span><br></pre></td></tr></table></figure>

<p>这种用法，前提是class唯一；</p>
<p>如果标签不同，但class相同，那就加上标签 ：</p>
<p><code>div.article-header h1</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [46]: response.css(<span class="string">&quot;.article-header h1&quot;</span>).extract()</span><br><span class="line">Out[46]: [<span class="string">&#x27;&lt;h1 class=&quot;post-title mb-2 mb-lg-3&quot;&gt;Apple 苹果产品参数中心 收集苹果全部产</span></span><br><span class="line"><span class="string">品的详细参数&lt;/h1&gt;&#x27;</span>]</span><br><span class="line"></span><br><span class="line">In [47]: response.css(<span class="string">&quot;.article-header h1::text&quot;</span>).extract()</span><br><span class="line">Out[47]: [<span class="string">&#x27;Apple 苹果产品参数中心 收集苹果全部产品的详细参数&#x27;</span>]</span><br><span class="line"></span><br><span class="line">In [48]: response.css(<span class="string">&quot;.article-header h1::text&quot;</span>).extract()[0]</span><br><span class="line">Out[48]: <span class="string">&#x27;Apple 苹果产品参数中心 收集苹果全部产品的详细参数&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>日期</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;article-meta&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;meta-date xh-highlight&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;far fa-clock me-1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    2023-09-14</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [50]: response.css(<span class="string">&quot;.meta-date&quot;</span>).extract()[0]</span><br><span class="line">Out[50]: <span class="string">&#x27;&lt;span class=&quot;meta-date&quot;&gt;&lt;i class=&quot;far fa-clock me-1&quot;&gt;&lt;/i&gt;2023-09-14&lt;/span&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">In [51]: response.css(<span class="string">&quot;.meta-date::text&quot;</span>).extract()[0]</span><br><span class="line">Out[51]: <span class="string">&#x27;2023-09-14&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>评论</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;meta-comment&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.ahhhhfs.com/18496/#comments&quot;</span> <span class="attr">class</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;far fa-comments me-1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [55]: response.css(<span class="string">&quot;.meta-comment&quot;</span>).extract()</span><br><span class="line">Out[55]: [<span class="string">&#x27;&lt;span class=&quot;meta-comment&quot;&gt;&lt;a href=&quot;https://www.ahhhhfs.com/18496/#comments&quot;&gt;&lt;i class=&quot;far fa-comments me-1&quot;&gt;&lt;/i&gt;1&lt;/a&gt;&lt;/span&gt;&#x27;</span>]</span><br><span class="line"></span><br><span class="line">In [56]: response.css(<span class="string">&quot;.meta-comment a&quot;</span>).extract()</span><br><span class="line">Out[56]: [<span class="string">&#x27;&lt;a href=&quot;https://www.ahhhhfs.com/18496/#comments&quot;&gt;&lt;i class=&quot;far fa-comments me-1&quot;&gt;&lt;/i&gt;1&lt;/a&gt;&#x27;</span>]</span><br><span class="line"></span><br><span class="line">In [57]: response.css(<span class="string">&quot;.meta-comment a::text&quot;</span>).extract()</span><br><span class="line">Out[57]: [<span class="string">&#x27;1&#x27;</span>]</span><br><span class="line"></span><br><span class="line">In [58]: response.css(<span class="string">&quot;.meta-comment a::text&quot;</span>).extract()[0]</span><br><span class="line">Out[58]: <span class="string">&#x27;1&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>收藏</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;article-meta&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;meta-date&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;far fa-clock me-1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    2023-09-14</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.ahhhhfs.com/it/apple/&quot;</span> <span class="attr">class</span>=<span class="string">&quot;&quot;</span>&gt;</span>Apple</span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;meta-fav d-none d-md-inline-block&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;far fa-star me-1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>3</span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>因为我这个页面下面会展示些其它的首页，封面也有这个收藏数，所以如果，仅仅是 <code>.fa-clock</code>会出现很多个数字，当然可以extract后取[0]</p>
<p>但是，多练练也没错，可以额外加一个div.article-meta</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [59]: response.css(<span class="string">&quot;span.meta-fav::text&quot;</span>).extract()</span><br><span class="line">Out[59]: [<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;9&#x27;</span>]</span><br><span class="line"></span><br><span class="line">In [60]: response.css(<span class="string">&quot;div.article-meta span.meta-fav::text&quot;</span>).extract()</span><br><span class="line">Out[60]: [<span class="string">&#x27;3&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>内容</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.css(<span class="string">&quot;article.post-content&quot;</span>).extract()[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#   #标题</span></span><br><span class="line"><span class="comment"># title=response.css(&quot;.article-header h1::text&quot;).extract()[0]</span></span><br><span class="line"><span class="comment"># #日期</span></span><br><span class="line"><span class="comment"># create_date= response.css(&quot;.meta-date::text&quot;).extract()[0]</span></span><br><span class="line"><span class="comment"># #评论</span></span><br><span class="line"><span class="comment"># comment=response.css(&quot;.meta-comment a::text&quot;).extract()[0]</span></span><br><span class="line"><span class="comment"># #喜欢数</span></span><br><span class="line"><span class="comment"># likes=response.css(&quot;div.article-meta span.meta-fav::text&quot;).extract()[0]</span></span><br><span class="line"><span class="comment"># #内容是个粗提取，没有进一步的操作</span></span><br><span class="line"><span class="comment"># content=response.css(&quot;article.post-content&quot;).extract()[0]</span></span><br></pre></td></tr></table></figure>



<h2 id="6-爬取所有网页"><a href="#6-爬取所有网页" class="headerlink" title="6.爬取所有网页"></a>6.爬取所有网页</h2><p>一个静态网页，搞好了，如何爬取所有静态网页呢？</p>
<p>目的为：</p>
<ol>
<li>获取某列表页的所有文章url，交给scrapy进行具体字段解析</li>
<li>获取下一页的url并交给scrapy重复1步骤</li>
</ol>
<h3 id="目的1："><a href="#目的1：" class="headerlink" title="目的1："></a>目的1：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_list=response.css(<span class="string">&quot;h2.entry-title a::attr(href)&quot;</span>).extract()</span><br></pre></td></tr></table></figure>

<p>取的是当前页所有的超链接的 href属性，这里面装着url</p>
<p>现在有一大串的url了</p>
<p><img src="https://raw.githubusercontent.com/ak005469075/myblog/main/img/image-20230922222831615.png" alt="处理代码"></p>
<p><code>url=parse.urljoin(response.url,post_url)</code>防止取的href里，没有域名，也就是url不完整，那就需要去拼接一下</p>
<h3 id="目的2："><a href="#目的2：" class="headerlink" title="目的2："></a>目的2：</h3><p>解析一下 <strong>下一页这个跳转页</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;page-link page-next&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://www...&quot;</span>&gt;</span>下一页<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fas fa-angle-right ms-1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用两个class进行定位：就是中间不留空格即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.css(<span class="string">&quot;.page-link.page-next::attr(href)&quot;</span>).extract_first(<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>extract_first(&quot;&quot;)</code>等价于 <code>extract()[0]</code>，但是多了一个默认为空</p>
<p>然后对它的进一步处理呢：</p>
<p>完整域名拼接，以及调用列表页的函数</p>
<h3 id="探讨"><a href="#探讨" class="headerlink" title="探讨"></a>探讨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">yield</span> Request(url=parse.urljoin(response.url,post_url),callback=self.parse_detail)</span><br></pre></td></tr></table></figure>

<p><code>parse.urljoin</code>，如果post_url有域名呢，不起作用；没域名，就拼接</p>
<h3 id="封面图的添加"><a href="#封面图的添加" class="headerlink" title="封面图的添加"></a>封面图的添加</h3><p>封面图一般出现在列表页上</p>
<p>由于列表页呢，超链接a中，它的属性href就是我们要的post_url；同时属性data-bg呢，存放的是封面链接image_url</p>
<p>所以对于上面的代码做个修改</p>
<p>对于列表页</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">post_node=response.css(<span class="string">&quot;a.media-img.lazy.bg-cover.bg-center&quot;</span>)</span><br><span class="line"><span class="comment">#对于封面链接image_url</span></span><br><span class="line">image_url=post_node.css(<span class="string">&quot;::attr(data-bg)&quot;</span>).extract_first(<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="7-item设计"><a href="#7-item设计" class="headerlink" title="7.item设计"></a>7.item设计</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WebItem</span>(scrapy.Item):</span><br><span class="line">    title=scrapy.Field()</span><br><span class="line">    url=scrapy.Field()</span><br><span class="line">    url_object_id=scrapy.Field()</span><br><span class="line">    create_data=scrapy.Field()</span><br><span class="line">    comment=scrapy.Field()</span><br><span class="line">    likes=scrapy.Field()</span><br><span class="line">    content=scrapy.Field()</span><br><span class="line">    front_image_url=scrapy.Field()</span><br><span class="line">    front_image_path=scrapy.Field()</span><br></pre></td></tr></table></figure>

<h3 id="Webspider-py"><a href="#Webspider-py" class="headerlink" title="Webspider.py"></a>Webspider.py</h3><p>然后再里导入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> name.items <span class="keyword">import</span> WebItem</span><br></pre></td></tr></table></figure>

<p><code>def parse_detail</code>中添加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">article_item=WebItem()</span><br><span class="line">...</span><br><span class="line">article_item[<span class="string">&quot;title&quot;</span>]=title</span><br><span class="line">article_item[<span class="string">&quot;url&quot;</span>]=response.url</span><br><span class="line">article_item[<span class="string">&quot;comment&quot;</span>]=comment</span><br><span class="line">article_item[<span class="string">&quot;likes&quot;</span>]=likes</span><br><span class="line">article_item[<span class="string">&quot;content&quot;</span>]=content</span><br><span class="line">article_item[<span class="string">&quot;create_date&quot;</span>]=create_date</span><br><span class="line">article_item[<span class="string">&quot;create_date&quot;</span>]=create_date</span><br><span class="line">article_item[<span class="string">&quot;front_image_url&quot;</span>]=front_image_url</span><br><span class="line"></span><br><span class="line"><span class="keyword">yield</span> article_item <span class="comment">#传入到pipelines去</span></span><br></pre></td></tr></table></figure>

<h3 id="settings-py"><a href="#settings-py" class="headerlink" title="settings.py"></a>settings.py</h3><h4 id="图片保存"><a href="#图片保存" class="headerlink" title="图片保存"></a>图片保存</h4><p>去settings.py取消以下代码的注释</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">&quot;name.pipelines.NamePipeline&quot;</span>: <span class="number">300</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加一下代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">    <span class="comment">#数字越小，越早进</span></span><br><span class="line">   <span class="string">&quot;name.pipelines.NamePipeline&quot;</span>: <span class="number">300</span>,</span><br><span class="line">   <span class="string">&quot;scrapy.pipelines.images.ImagesPipeline&quot;</span>:<span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line">IMAGES_URLS_FIELD=<span class="string">&quot;front_image_url&quot;</span> <span class="comment">#使得它去items找该&quot;front_image_url&quot;字段</span></span><br><span class="line">project_dir=os.path.abspath((os.path.dirname(__file__)))</span><br><span class="line">IMAGES_STORE=os.path.join(project_dir,<span class="string">&#x27;images&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>去根文件夹name新建images文件夹</p>
<p>由于是对图片操作，需要一个PIL库</p>
<p>在终端安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i https://pypi.douban.com/simple pillow</span><br></pre></td></tr></table></figure>

<p>然后由于会将 <code>IMAGES_URLS_FIELD=&quot;front_image_url&quot;</code>值当做数组</p>
<p>需要去webspider中将该值中括号括起</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">article_item[<span class="string">&quot;front_image_url&quot;</span>]=[front_image_url]</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p> 启动运行的是main.py文件，不要搞错了，<del>我当时才没搞错</del></p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>运行完后，在images文件夹下有一个full文件夹，图片只有13个，根据当时实际列表页来看，有13页，一页有16个封面；这远远不够诶。当时调试时，也有发现，有的post_url，貌似并没有调入到 parse_detail方法</p>
<p>它不会是13个页面，一个页面搞一个图吧</p>
<p>我注释掉了 <code>next_url</code>那串代码</p>
<p>运行后，只下载到第一个图</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [50]: <span class="keyword">for</span> post_url <span class="keyword">in</span> post_nodes:</span><br><span class="line">    ...:      post_url=post_nodes.css(<span class="string">&quot;::attr(href)&quot;</span>).extract_first(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    ...:      <span class="built_in">print</span>(post_url)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>果然，出现在了 <code>extract_first(&quot;&quot;)</code>上，这样一直遍历的是第一个</p>
</blockquote>
<p>更改如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">post_nodes=response.css(<span class="string">&quot;a.media-img.lazy.bg-cover.bg-center&quot;</span>)</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> post_url <span class="keyword">in</span> post_nodes:</span><br><span class="line">                <span class="keyword">if</span> i&lt;<span class="built_in">len</span>(post_nodes):</span><br><span class="line">                      <span class="comment">#yield Request(url=parse.urljoin(response.url,post_url),callback=self.parse_detail)</span></span><br><span class="line">                    image_url=post_nodes.css(<span class="string">&quot;::attr(data-bg)&quot;</span>).extract()[i]</span><br><span class="line">                    post_url=post_nodes.css(<span class="string">&quot;::attr(href)&quot;</span>).extract()[i]</span><br><span class="line">                    <span class="keyword">yield</span> Request(url=parse.urljoin(response.url,post_url),meta=&#123;<span class="string">&quot;front_image_url&quot;</span>:image_url&#125;,callback=self.parse_detail)</span><br><span class="line">                    i=i+<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>好吧，进行到后面我才发现，应该这样改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> post_node <span class="keyword">in</span> post_nodes:</span><br><span class="line"></span><br><span class="line">image_url=post_node.css(<span class="string">&quot;::attr(data-bg)&quot;</span>).extract_first(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">post_url=post_node.css(<span class="string">&quot;::attr(href)&quot;</span>).extract_first(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">yield</span> Request(url=parse.urljoin(response.url,post_url),meta=&#123;<span class="string">&quot;front_image_url&quot;</span>:image_url&#125;,callback=self.parse_detail)</span><br></pre></td></tr></table></figure>



<h3 id="Items字段填充"><a href="#Items字段填充" class="headerlink" title="Items字段填充"></a>Items字段填充</h3><h4 id="填充front-image-url"><a href="#填充front-image-url" class="headerlink" title="填充front_image_url"></a>填充front_image_url</h4><h5 id="自定义pipelines"><a href="#自定义pipelines" class="headerlink" title="自定义pipelines"></a>自定义pipelines</h5><p>为了保存图片路径，代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.pipelines.images <span class="keyword">import</span> ImagesPipeline</span><br><span class="line">...</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameImagePipeline</span>(<span class="title class_ inherited__">ImagesPipeline</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">item_completed</span>(<span class="params">self, results, item, info</span>):  </span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;front_image_url&quot;</span> <span class="keyword">in</span> item:</span><br><span class="line">            <span class="keyword">for</span> ok,value <span class="keyword">in</span> results:</span><br><span class="line">                image_file_path=value[<span class="string">&quot;path&quot;</span>]</span><br><span class="line"></span><br><span class="line">            item[<span class="string">&quot;front_image_path&quot;</span>]=image_file_path</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>

<p>管道里，填充了 <code>front_image_path</code></p>
<h5 id="自定义settings"><a href="#自定义settings" class="headerlink" title="自定义settings"></a>自定义settings</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">    <span class="comment">#数字越小，越早进</span></span><br><span class="line">   <span class="string">&quot;name.pipelines.NamePipeline&quot;</span>: <span class="number">300</span>,</span><br><span class="line">   <span class="comment">#&quot;scrapy.pipelines.images.ImagesPipeline&quot;:1,</span></span><br><span class="line">   <span class="string">&quot;name.pipelines.NameImagePipeline&quot;</span>: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="填充url-object-id"><a href="#填充url-object-id" class="headerlink" title="填充url_object_id"></a>填充url_object_id</h4><p>新建utils文件夹中一个common.py，用来做md5加密</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_md5</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(url,<span class="built_in">str</span>):<span class="comment">#python3 里的str 相当于python2的unicode</span></span><br><span class="line">        url=url.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    m=hashlib.md5()</span><br><span class="line">    m.update(url)</span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br></pre></td></tr></table></figure>

<h5 id="自定义爬虫文件webspider"><a href="#自定义爬虫文件webspider" class="headerlink" title="自定义爬虫文件webspider"></a>自定义爬虫文件webspider</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> name.utils.common <span class="keyword">import</span> get_md5</span><br><span class="line">...</span><br><span class="line">article_item[<span class="string">&quot;url_object_id&quot;</span>]=get_md5(response.url)</span><br></pre></td></tr></table></figure>

<h2 id="8-数据表设计和保存item到json文件"><a href="#8-数据表设计和保存item到json文件" class="headerlink" title="8.数据表设计和保存item到json文件"></a>8.数据表设计和保存item到json文件</h2><h3 id="1-保存item到json文件"><a href="#1-保存item到json文件" class="headerlink" title="1.保存item到json文件"></a>1.保存item到json文件</h3><h4 id="自定义json导出"><a href="#自定义json导出" class="headerlink" title="自定义json导出"></a>自定义json导出</h4><h5 id="pipelines"><a href="#pipelines" class="headerlink" title="pipelines"></a>pipelines</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JsonwithEncodingPipeline</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">      self.file=codecs.<span class="built_in">open</span>(<span class="string">&#x27;article.json&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self, item, spider</span>): <span class="comment">#写入文件</span></span><br><span class="line">        lines=json.dumps(<span class="built_in">dict</span>(item),ensure_ascii=<span class="literal">False</span>)+<span class="string">&quot;\n&quot;</span></span><br><span class="line">        self.file.write(lines)</span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">spider_closed</span>(<span class="params">self,spider</span>):<span class="comment">#关闭文件</span></span><br><span class="line">       self.file.close()</span><br><span class="line">        <span class="comment">#ensure_ascii=False有中文不出错</span></span><br></pre></td></tr></table></figure>

<h5 id="settings"><a href="#settings" class="headerlink" title="settings"></a>settings</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">    <span class="comment">#数字越小，越早进</span></span><br><span class="line">   <span class="string">&quot;name.pipelines.JsonwithEncodingPipeline&quot;</span>: <span class="number">2</span>,</span><br><span class="line">   <span class="comment">#&quot;scrapy.pipelines.images.ImagesPipeline&quot;:1,</span></span><br><span class="line">   <span class="string">&quot;name.pipelines.NameImagePipeline&quot;</span>: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h5><p>生成了article.json文件，有json格式，看着很清楚</p>
<h4 id="scrapy导出json"><a href="#scrapy导出json" class="headerlink" title="scrapy导出json"></a>scrapy导出json</h4><h5 id="pipelines-1"><a href="#pipelines-1" class="headerlink" title="pipelines"></a>pipelines</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.exporters <span class="keyword">import</span> JsonItemExporter</span><br><span class="line">...</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JsonExporterPipeline</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="comment">#调用由scrapy提供的json_export导出json文件</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.file=<span class="built_in">open</span>(<span class="string">&#x27;articleexport.json&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">        self.exporter=JsonItemExporter(self.file,encoding=<span class="string">&quot;utf-8&quot;</span>,ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        self.exporter.start_exporting()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close_spider</span>(<span class="params">self,spider</span>):</span><br><span class="line">        self.exporter.finish_exporting()</span><br><span class="line">        self.file.close()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self,item,spider</span>):</span><br><span class="line">        self.exporter.export_item(item)</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>

<blockquote>
<p>显示的结果嘛，比自定义的json导出，多了个 []</p>
</blockquote>
<p>然后settings记得改一改，就对应的管道那</p>
<h3 id="2-数据库设计"><a href="#2-数据库设计" class="headerlink" title="2.数据库设计"></a>2.数据库设计</h3><p>数据库管理工具用的navicat，mysql用的是phpstudy自带的哈</p>
<p>数据库设计如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `article_spider` (</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;标题&#x27;</span>,</span><br><span class="line">  `create_date` <span class="type">date</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;时间&#x27;</span>,</span><br><span class="line">  `url` <span class="type">varchar</span>(<span class="number">300</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `url_object_id` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `front_image_url` <span class="type">varchar</span>(<span class="number">300</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `front_image_path` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `comment` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `likes` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `content` longtext <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`url_object_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>MyISAM <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_unicode_ci;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后webspider里对create-date处理一下，字符串转datetime</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">             create_date=datetime.datetime.strptime(create_date,<span class="string">&quot;%Y/%m/%d&quot;</span>).date()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">             create_date=datetime.datetime.now.date()</span><br></pre></td></tr></table></figure>

<p>终端安装一下mysqlclient <code>pip install mysqlclient</code></p>
<h4 id="同步类"><a href="#同步类" class="headerlink" title="同步类"></a>同步类</h4><h5 id="pipelines-2"><a href="#pipelines-2" class="headerlink" title="pipelines"></a>pipelines</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Mysqlpipeline</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment">#&#x27;host&#x27;,&#x27;user&#x27;,&#x27;password&#x27;,&#x27;dbname&#x27;</span></span><br><span class="line">        self.conn=MySQLdb.connect(<span class="string">&#x27;localhost&#x27;</span>,<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;mydb&#x27;</span>,charset=<span class="string">&quot;utf8&quot;</span>,use_unicode=<span class="literal">True</span>)</span><br><span class="line">        self.cursor=self.conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self,item,spider</span>):</span><br><span class="line">        insert_sql=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            insert into article_spider(title,url,create_date,likes)</span></span><br><span class="line"><span class="string">            values(%s,%s,%s,%s)</span></span><br><span class="line"><span class="string">      &quot;&quot;&quot;</span></span><br><span class="line">        self.cursor.execute(insert_sql,(item[<span class="string">&quot;title&quot;</span>],item[<span class="string">&quot;url&quot;</span>],item[<span class="string">&quot;create_date&quot;</span>],item[<span class="string">&quot;likes&quot;</span>]))</span><br><span class="line">        self.conn.commit()</span><br></pre></td></tr></table></figure>

<p>然后settings里，添加这个管道的，注释其它管道的</p>
<p>为了演示，只添上面四个字段 <code>title,url,create_date,likes</code>，避免mysql报错，将主键先取消掉，<strong>不为空</strong>的字段<strong>加上默认值</strong></p>
<blockquote>
<p>结果，成功了</p>
</blockquote>
<h5 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h5><p><code>MySQLdb.OperationalError: (2013, &#39;Lost connection to server during query&#39;)</code></p>
<p><code>MySQLdb.OperationalError: (2006, &#39;Server has gone away&#39;)</code></p>
<p>这个其实是断点，debug太久导致了数据库连接超时</p>
<h4 id="异步化类"><a href="#异步化类" class="headerlink" title="异步化类"></a>异步化类</h4><p>防止scrapy解析过快，数据库写入速度跟不上而阻塞</p>
<h5 id="pipelines-3"><a href="#pipelines-3" class="headerlink" title="pipelines"></a>pipelines</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> MySQLdb</span><br><span class="line"><span class="keyword">import</span> MySQLdb.cursors</span><br><span class="line"><span class="keyword">from</span> twisted.enterprise <span class="keyword">import</span> adbapi</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mysqltwistedpipeline</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,dbpool</span>):</span><br><span class="line">        self.dbpool=dbpool</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_settings</span>(<span class="params">cls,settings</span>):</span><br><span class="line">       <span class="comment">#dict()是一个类</span></span><br><span class="line">       dbparams= <span class="built_in">dict</span>(</span><br><span class="line">            <span class="comment">#左边的值不是乱定义的哈</span></span><br><span class="line">        host=settings[<span class="string">&quot;MYSQL_HOST&quot;</span>],</span><br><span class="line">        db=settings[<span class="string">&quot;MYSQL_DBNAME&quot;</span>],</span><br><span class="line">        user=settings[<span class="string">&quot;MYSQL_USER&quot;</span>],</span><br><span class="line">        passwd=settings[<span class="string">&quot;MYSQL_PASSWORD&quot;</span>],</span><br><span class="line">        charset=<span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">        cursorclass=MySQLdb.cursors.DictCursor,</span><br><span class="line">        use_unicode=<span class="literal">True</span>,</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">#dbpool=adbapi.ConnectionPool(&quot;MySQLdb&quot;, host=settings[&quot;MYSQL_HOST&quot;],</span></span><br><span class="line"><span class="comment">#db=settings[&quot;MYSQL_DBNAME&quot;],user=settings[&quot;MYSQL_USER&quot;]...)</span></span><br><span class="line">		<span class="comment">#或者</span></span><br><span class="line">       dbpool=adbapi.ConnectionPool(<span class="string">&quot;MySQLdb&quot;</span>,**dbparams)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> cls(dbpool) <span class="comment">#实例化对象 </span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self,item,spider</span>):</span><br><span class="line">        <span class="comment">#使用twist将Mysql插入变为异步执行</span></span><br><span class="line">        query=self.dbpool.runInteraction(self.do_insert,item)</span><br><span class="line">        <span class="comment">#错误处理</span></span><br><span class="line">        query.addErrback(self.handle_error)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_error</span>(<span class="params">self,failure</span>):</span><br><span class="line">        <span class="comment">#处理异步插入的异常</span></span><br><span class="line">        <span class="built_in">print</span>(failure)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_insert</span>(<span class="params">self,cursor,item</span>):</span><br><span class="line">        <span class="comment">#执行具体插入</span></span><br><span class="line">        insert_sql=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            insert into article_spider(title,url,create_date,likes)</span></span><br><span class="line"><span class="string">            values(%s,%s,%s,%s)</span></span><br><span class="line"><span class="string">      &quot;&quot;&quot;</span></span><br><span class="line">        cursor.execute(insert_sql,(item[<span class="string">&quot;title&quot;</span>],item[<span class="string">&quot;url&quot;</span>],item[<span class="string">&quot;create_date&quot;</span>],item[<span class="string">&quot;likes&quot;</span>]))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="settings-1"><a href="#settings-1" class="headerlink" title="settings"></a>settings</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;name.pipelines.Mysqltwistedpipeline&quot;</span>:<span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">MYSQL_HOST=<span class="string">&quot;localhost&quot;</span></span><br><span class="line">MYSQL_DBNAME=<span class="string">&quot;db&quot;</span></span><br><span class="line">MYSQL_USER=<span class="string">&quot;root&quot;</span></span><br><span class="line">MYSQL_PASSWORD=<span class="string">&quot;root&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="问题-2"><a href="#问题-2" class="headerlink" title="问题"></a>问题</h5><p><strong>问题1</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">instance = objcls.from_settings(settings, *args, **kwargs)</span><br><span class="line">File <span class="string">&quot;&quot;</span>, line <span class="number">70</span>, <span class="keyword">in</span> from_settings</span><br><span class="line"><span class="keyword">return</span> cls(dbpool) <span class="comment">#实例化对象</span></span><br><span class="line">builtins.TypeError: Mysqltwistedpipeline() takes no arguments</span><br></pre></td></tr></table></figure>

<p>解决方法，纯粹是 <code>__init__</code>拼写错了</p>
<p><strong>问题2</strong>：<code>&#39;Deferred&#39; object has no attribute &#39;addErrorback&#39;</code></p>
<p>改成addErrBack()</p>
<h2 id="9-item-loader机制"><a href="#9-item-loader机制" class="headerlink" title="9.item loader机制"></a>9.item loader机制</h2><p><strong>如果有个爬虫代码有大量的xpath和css很多的时候，不好改</strong></p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader </span><br><span class="line">...</span><br><span class="line"> <span class="comment">#通过Itemloader加载item</span></span><br><span class="line"></span><br><span class="line">item_loader=WebItemLoader(item=WebItem(),response=response)</span><br><span class="line">item_loader.add_xpath(<span class="string">&quot;title&quot;</span>,<span class="string">&#x27;//div[@class=&quot;article-header mb-0&quot;]/h1/text()&#x27;</span>)</span><br><span class="line"><span class="comment">#item_loader.add_css()</span></span><br><span class="line">item_loader.add_value(<span class="string">&quot;url&quot;</span>,response.url)</span><br><span class="line">item_loader.add_value(<span class="string">&quot;url_object_id&quot;</span>,get_md5(response.url))</span><br><span class="line">item_loader.add_xpath(<span class="string">&quot;comment&quot;</span>,<span class="string">&#x27;//span[@class=&quot;meta-comment&quot;]/a/text()&#x27;</span>)</span><br><span class="line">item_loader.add_xpath(<span class="string">&quot;likes&quot;</span>,<span class="string">&#x27;//div[@class=&quot;article-meta&quot;]/span[contains(@class,&quot;meta-fav&quot;)]/text()&#x27;</span>)</span><br><span class="line">item_loader.add_xpath(<span class="string">&quot;content&quot;</span>,<span class="string">&#x27;//div[@class=&quot;card&quot;]/article&#x27;</span>)</span><br><span class="line">item_loader.add_xpath(<span class="string">&quot;create_date&quot;</span>,<span class="string">&quot;//div[@class=&#x27;article-meta&#x27;]/span[1]/text()&quot;</span>)</span><br><span class="line"></span><br><span class="line">front_image_url=response.meta.get(<span class="string">&quot;front_image_url&quot;</span>,<span class="string">&quot;&quot;</span>) </span><br><span class="line">item_loader.add_value(<span class="string">&quot;front_image_url&quot;</span>,[front_image_url])</span><br><span class="line"></span><br><span class="line">article_item=item_loader.load_item()</span><br></pre></td></tr></table></figure>

<p>但有个问题：</p>
<blockquote>
<p>1.它这里每个值加载的是list形式了</p>
<p>2.像字段由字符串处理成date格式，即一些处理怎么做</p>
</blockquote>
<h3 id="处理方式"><a href="#处理方式" class="headerlink" title="处理方式"></a>处理方式</h3><h4 id="MapCompose"><a href="#MapCompose" class="headerlink" title="MapCompose"></a>MapCompose</h4><p><strong>用来对原始值进一步处理</strong></p>
<p>在items.py中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy,datetime</span><br><span class="line"><span class="keyword">from</span> scrapy.loader.processors <span class="keyword">import</span> MapCompose</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_webspider</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="keyword">return</span> value+<span class="string">&quot;-yuleiyun&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebItem</span>(scrapy.Item):</span><br><span class="line">    title=scrapy.Field(</span><br><span class="line">        <span class="comment">#从左到右拼接</span></span><br><span class="line">        input_processor=MapCompose(<span class="keyword">lambda</span> x:x+<span class="string">&quot;-webspider&quot;</span>,add_webspider)</span><br><span class="line">    )</span><br><span class="line">    ...</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>这样会使得webspider中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">article_item=item_loader.load_item()</span><br><span class="line">其title字段会拼接 <span class="string">&quot;-webspider-yuleiyun&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="TaskFirst"><a href="#TaskFirst" class="headerlink" title="TaskFirst"></a>TaskFirst</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processors <span class="keyword">import</span> MapCompose,TakeFirst</span><br><span class="line"></span><br><span class="line">title=scrapy.Field(</span><br><span class="line">        <span class="comment">#从左到右拼接</span></span><br><span class="line">        input_processor=MapCompose(<span class="keyword">lambda</span> x:x+<span class="string">&quot;-webspider&quot;</span>,add_webspider),</span><br><span class="line">    	output_processor=TakeFirst()</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样结果就不是列表形式了</p>
</blockquote>
<h3 id="create-date字段同理"><a href="#create-date字段同理" class="headerlink" title="create_date字段同理"></a>create_date字段同理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">date_convert</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        create_date=datetime.datetime.strptime(val,<span class="string">&quot;%Y/%m/%d&quot;</span>).date()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        create_date=datetime.datetime.now().date()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> create_date</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">create_date=scrapy.Field(</span><br><span class="line">        input_processor=MapCompose(date_convert),</span><br><span class="line">        output_processor=TakeFirst()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>输出效果为：处理过的，且非list类型而是date类型的字段</p>
</blockquote>
<h3 id="处理方式改进"><a href="#处理方式改进" class="headerlink" title="处理方式改进"></a>处理方式改进</h3><p>当然了，如果一个字段就加一个output_processor的话，如果有100个呢？</p>
<p>那为了让所有字段都取第一个值，那就自定义一个ItemLoader类</p>
<h4 id="items"><a href="#items" class="headerlink" title="items"></a>items</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line">...</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebItemLoader</span>(<span class="title class_ inherited__">ItemLoader</span>):</span><br><span class="line">    <span class="comment">#自定义ItemLoader</span></span><br><span class="line">    default_output_processor=TakeFirst()</span><br></pre></td></tr></table></figure>

<p><strong>去掉原来的output_processor</strong></p>
<h4 id="webspider"><a href="#webspider" class="headerlink" title="webspider"></a>webspider</h4><p>使用自定义的Itemloader类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> name.items <span class="keyword">import</span> WebItem,WebItemLoader</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">item_loader=WebItemLoader(item=WebItem(),response=response)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>Debug，可以明显看到，所有字段不再是list形式了</strong></p>
<h3 id="正则表达式处理"><a href="#正则表达式处理" class="headerlink" title="正则表达式处理"></a>正则表达式处理</h3><p>如果之前有的字段，scrapy提取后，需要正则进一步提取</p>
<p>同上，新建一个有参的函数，函数体复制过来，return一下处理结果就行了</p>
<h3 id="特殊处理"><a href="#特殊处理" class="headerlink" title="特殊处理"></a>特殊处理</h3><p>上面有一个这样的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tag_list=[elem <span class="keyword">for</span> elem <span class="keyword">in</span> tag <span class="keyword">if</span> <span class="keyword">not</span> elem.strip().endwith(<span class="string">&quot;评论&quot;</span>)]</span><br><span class="line">tags=<span class="string">&quot;,&quot;</span>.join(tag_list)</span><br></pre></td></tr></table></figure>

<p>这个tags实际就是个字符串</p>
<h4 id="join"><a href="#join" class="headerlink" title="join"></a>join</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processors <span class="keyword">import</span> MapCompose,TakeFirst,join</span><br><span class="line">...</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove_tags_comment</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;评论&quot;</span> <span class="keyword">in</span> val:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> val</span><br><span class="line">    </span><br><span class="line">...</span><br><span class="line">input_processor=MapCompose(remove_tags_comment),</span><br><span class="line">output_processor=join(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="front-image-url"><a href="#front-image-url" class="headerlink" title="front_image_url"></a>front_image_url</h4><p>当时处理这个字段的时候，是要将它作为list的，由于自定义处理使得它不为list了，所以需要处理一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对于需要保持list的字段所做处理</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">return_val</span>(<span class="params">val</span>):</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">front_image_url=scrapy.Field(</span><br><span class="line">        <span class="comment">#覆盖default_output_processor</span></span><br><span class="line">       output_processor=MapCompose(return_val)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h2 id="10-总结"><a href="#10-总结" class="headerlink" title="10.总结"></a>10.总结</h2><p>学习了正则表达式应用</p>
<p>学习了scrapy框架的安装，项目初步建立</p>
<p>学习了使用vscode调试scrapy项目</p>
<p>学习了scrapy文件结构，主要文件为 主爬虫脚本、Items.py、pipelines.py、settings.py</p>
<p><strong>主爬虫脚本：</strong></p>
<ol>
<li>设置爬虫目标网站</li>
<li>使用response.xpath、response.css解析目标网站字段</li>
<li>对于字段的存储，使用items中的实体类保存-&gt;使用默认scrapy item_loader-&gt;使用<strong>自定义scrapy item_loader</strong></li>
<li>对于ItemLoader，主要有三个方法，<code>add_xpath()，add_css()，add_value()</code></li>
</ol>
<p><strong>items.py</strong></p>
<ol>
<li>封装爬取目标的信息</li>
<li>运用自定义方法，与类中各字段的搭配</li>
<li>搭配方法有<code>MapCompose</code>、<code>TakeFirst</code></li>
<li>传递到<strong>pipelines</strong></li>
</ol>
<p><strong>pipelines.py</strong></p>
<ol>
<li>接收<strong>items</strong>的返回值</li>
<li>进行保存，json存储-&gt;同步化数据库-&gt;<strong>异步化数据库</strong></li>
</ol>
<p><strong>settings</strong></p>
<ol>
<li>对管道pipelines中的类进行，优先度分配</li>
<li>系统常量的定义，如MYSQL_HOST、IMAGES_URLS_FIELD</li>
</ol>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://ak005469075.github.io/2023/09/22/python%E7%88%AC%E8%99%AB/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/09/22/narak/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            narak-难点
          
        </div>
      </a>
    
    
      <a href="/2023/09/21/C1F/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">C1F</div>
      </a>
    
  </nav>

  
   
<div class="gitalk" id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.7.2/gitalk.min.css">


<script src="https://cdn.staticfile.org/gitalk/1.7.2/gitalk.min.js"></script>


<script src="https://cdn.staticfile.org/blueimp-md5/2.19.0/js/md5.min.js"></script>

<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '93da8388ad1469a8be66',
    clientSecret: '9dea6314b14ae1877632f2bcbe0a639dd4485bb1',
    repo: 'blogtalk',
    owner: 'ak005469075',
    admin: ['ak005469075'],
    // id: location.pathname,      // Ensure uniqueness and length less than 50
    id: md5(location.pathname),
    distractionFreeMode: false,  // Facebook-like distraction free mode
    pagerDirection: 'last'
  })

  gitalk.render('gitalk-container')
</script>

  
    
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2023-2024
        <i class="ri-heart-fill heart_icon"></i> 是羽泪云诶
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/favicon.ico" alt="小张之栈"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/htb">HTB</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
  <script type="text/javascript">
$(function () {
    console.log("lets go！");
    console.log("/");
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
</div>

</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<script src="https://cdn.staticfile.org/animejs/3.2.1/anime.min.js"></script>

<script src="/js/clickBoom1.js"></script>
 
<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>